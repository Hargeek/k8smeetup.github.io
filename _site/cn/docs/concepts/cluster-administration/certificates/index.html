<ul id="markdown-toc">
  <li><a href="#创建证书" id="markdown-toc-创建证书">创建证书</a>    <ul>
      <li><a href="#使用现有部署脚本" id="markdown-toc-使用现有部署脚本">使用现有部署脚本</a></li>
      <li><a href="#easyrsa" id="markdown-toc-easyrsa">easyrsa</a></li>
      <li><a href="#openssl" id="markdown-toc-openssl">openssl</a></li>
      <li><a href="#cfssl" id="markdown-toc-cfssl">cfssl</a></li>
    </ul>
  </li>
  <li><a href="#分发自签名-ca-证书" id="markdown-toc-分发自签名-ca-证书">分发自签名 CA 证书</a></li>
  <li><a href="#证书-api" id="markdown-toc-证书-api">证书 API</a></li>
</ul>

<h2 id="创建证书">创建证书</h2>

<p>当使用客户端证书进行认证时，用户可以使用现有部署脚本，或者通过 <code class="highlighter-rouge">easyrsa</code>、<code class="highlighter-rouge">openssl</code> 或
<code class="highlighter-rouge">cfssl</code> 手动生成证书。</p>

<h3 id="使用现有部署脚本">使用现有部署脚本</h3>

<p><strong>现有部署脚本</strong> 位于
<code class="highlighter-rouge">cluster/saltbase/salt/generate-cert/make-ca-cert.sh</code>。</p>

<p>执行该脚本时需传入两个参数。 第一个参数为 API 服务器的 IP 地址，第二个参数为对象的候补名称列表，
形如 <code class="highlighter-rouge">IP:&lt;ip地址&gt; 或 DNS:&lt;dns名称&gt;</code>。</p>

<p>脚本生成三个文件： <code class="highlighter-rouge">ca.crt</code>、<code class="highlighter-rouge">server.crt</code> 和 <code class="highlighter-rouge">server.key</code>。</p>

<p>最后，将以下参数加入到  API 服务器的启动参数中：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--client-ca-file=/srv/kubernetes/ca.crt
--tls-cert-file=/srv/kubernetes/server.crt
--tls-private-key-file=/srv/kubernetes/server.key
</code></pre></div></div>

<h3 id="easyrsa">easyrsa</h3>

<p>使用 <strong>easyrsa</strong> 能够手动地为集群生成证书。</p>

<ol>
  <li>
    <p>下载、解压并初始化 easyrsa3 的补丁版本。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -L -O https://storage.googleapis.com/kubernetes-release/easy-rsa/easy-rsa.tar.gz
tar xzf easy-rsa.tar.gz
cd easy-rsa-master/easyrsa3
./easyrsa init-pki
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成 CA（通过 <code class="highlighter-rouge">--batch</code> 参数设置自动模式。 通过 <code class="highlighter-rouge">--req-cn</code> 设置默认使用的 CN）</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./easyrsa --batch "--req-cn=${MASTER_IP}@`date +%s`" build-ca nopass
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成服务器证书和密钥。
参数 <code class="highlighter-rouge">--subject-alt-name</code> 设置了访问 API 服务器时可能使用的 IP 和 DNS 名称。 <code class="highlighter-rouge">MASTER_CLUSTER_IP</code>
通常为 <code class="highlighter-rouge">--service-cluster-ip-range</code> 参数中指定的服务 CIDR 的 首个 IP 地址，<code class="highlighter-rouge">--service-cluster-ip-range</code>同时用于
API 服务器和控制器管理器组件。  <code class="highlighter-rouge">--days</code> 参数用于设置证书的有效期限。
下面的示例还假设用户使用 <code class="highlighter-rouge">cluster.local</code> 作为默认的 DNS 域名。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./easyrsa --subject-alt-name="IP:${MASTER_IP}"\
"IP:${MASTER_CLUSTER_IP},"\
"DNS:kubernetes,"\
"DNS:kubernetes.default,"\
"DNS:kubernetes.default.svc,"\
"DNS:kubernetes.default.svc.cluster,"\
"DNS:kubernetes.default.svc.cluster.local" \
--days=10000 \
build-server-full server nopass
</code></pre></div>    </div>
  </li>
  <li>拷贝 <code class="highlighter-rouge">pki/ca.crt</code>、 <code class="highlighter-rouge">pki/issued/server.crt</code> 和 <code class="highlighter-rouge">pki/private/server.key</code> 至您的目录。</li>
  <li>
    <p>填充并在 API 服务器的启动参数中添加以下参数：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--client-ca-file=/yourdirectory/ca.crt
--tls-cert-file=/yourdirectory/server.crt
--tls-private-key-file=/yourdirectory/server.key
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="openssl">openssl</h3>

<p>使用 <strong>openssl</strong> 能够手动地为集群生成证书。</p>

<ol>
  <li>
    <p>生成密钥位数为 2048 的 ca.key：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa -out ca.key 2048
</code></pre></div>    </div>
  </li>
  <li>
    <p>依据 ca.key 生成 ca.crt （使用 -days 参数来设置证书有效时间）：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req -x509 -new -nodes -key ca.key -subj "/CN=${MASTER_IP}" -days 10000 -out ca.crt
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成密钥位数为 2048 的 server.key：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa -out server.key 2048
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建用于生成证书签名请求（CSR）的配置文件。
确保在将其保存至文件（如<code class="highlighter-rouge">csr.conf</code>）之前将尖括号标记的值（如<code class="highlighter-rouge">&lt;MASTER_IP&gt;</code>）
替换为你想使用的真实值。 注意：<code class="highlighter-rouge">MASTER_CLUSTER_IP</code> 是前面小节中描述的 API 服务器的服务集群 IP
(service cluster IP)。 下面的示例也假设用户使用 <code class="highlighter-rouge">cluster.local</code> 作为默认的 DNS 域名。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ req ]
default_bits = 2048
prompt = no
default_md = sha256
req_extensions = req_ext
distinguished_name = dn
    
[ dn ]
C = &lt;country&gt;
ST = &lt;state&gt;
L = &lt;city&gt;
O = &lt;organization&gt;
OU = &lt;organization unit&gt;
CN = &lt;MASTER_IP&gt;
    
[ req_ext ]
subjectAltName = @alt_names
    
[ alt_names ]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster
DNS.5 = kubernetes.default.svc.cluster.local
IP.1 = &lt;MASTER_IP&gt;
IP.2 = &lt;MASTER_CLUSTER_IP&gt;
    
[ v3_ext ]
authorityKeyIdentifier=keyid,issuer:always
basicConstraints=CA:FALSE
keyUsage=keyEncipherment,dataEncipherment
extendedKeyUsage=serverAuth,clientAuth
subjectAltName=@alt_names
</code></pre></div>    </div>
  </li>
  <li>
    <p>基于配置文件生成证书签名请求：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req -new -key server.key -out server.csr -config csr.conf
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用 ca.key、ca.crt 和 server.csr 生成服务器证书：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \
-CAcreateserial -out server.crt -days 10000 \
-extensions v3_ext -extfile csr.conf
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看证书：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509  -noout -text -in ./server.crt
</code></pre></div>    </div>
  </li>
</ol>

<p>最后，添加同样的参数到  API 服务器的启动参数中。</p>

<h3 id="cfssl">cfssl</h3>

<p><strong>cfssl</strong> 是另一种用来生成证书的工具。</p>

<ol>
  <li>
    <p>按如下所示的方式下载、解压并准备命令行工具。
注意：你可能需要基于硬件架构和你所使用的 cfssl 版本对示例命令进行修改。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -LO https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o cfssl
chmod +x cfssl
curl -LO https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o cfssljson
chmod +x cfssljson
curl -LO https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o cfssl-certinfo
chmod +x cfssl-certinfo
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建目录来存放物料，并初始化 cfssl：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir cert
cd cert
../cfssl print-defaults config &gt; config.json
../cfssl print-defaults csr &gt; csr.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建用来生成 CA 文件的 JSON 配置文件，例如 <code class="highlighter-rouge">ca-config.json</code>：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "signing": {
    "default": {
      "expiry": "8760h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth",
        ],
        "expiry": "8760h"
      }
    }
  }
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件，例如 <code class="highlighter-rouge">ca-csr.json</code>。
确保将尖括号标记的值替换为你想使用的真实值。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names":[{
    "C": "&lt;country&gt;",
    "ST": "&lt;state&gt;",
    "L": "&lt;city&gt;",
    "O": "&lt;organization&gt;",
    "OU": "&lt;organization unit&gt;",
  }]
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成 CA 密钥（<code class="highlighter-rouge">ca-key.pem</code>）和证书（<code class="highlighter-rouge">ca.pem</code>）：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../cfssl gencert -initca ca-csr.json | ../cfssljson -bare ca
</code></pre></div>    </div>
  </li>
  <li>
    <p>按如下所示的方式创建用来为 API 服务器生成密钥和证书的 JSON 配置文件。
确保将尖括号标记的值替换为你想使用的真实值。 <code class="highlighter-rouge">MASTER_CLUSTER_IP</code> 是前面小节中描述的
API 服务器的服务集群 IP。 下面的示例也假设用户使用 <code class="highlighter-rouge">cluster.local</code> 作为默认的 DNS 域名。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "CN": "kubernetes",
  "hosts": [
    "127.0.0.1",
    "&lt;MASTER_IP&gt;",
    "&lt;MASTER_CLUSTER_IP&gt;",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.cluster",
    "kubernetes.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "&lt;country&gt;",
    "ST": "&lt;state&gt;",
    "L": "&lt;city&gt;",
    "O": "&lt;organization&gt;",
    "OU": "&lt;organization unit&gt;"
  }]
} 
</code></pre></div>    </div>
  </li>
  <li>
    <p>为 API 服务器生成密钥和证书，生成的秘钥和证书分别默认保存在文件 <code class="highlighter-rouge">server-key.pem</code>
和 <code class="highlighter-rouge">server.pem</code> 中：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
--config=ca-config.json -profile=kubernetes \
server-csr.json | ../cfssljson -bare server
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="分发自签名-ca-证书">分发自签名 CA 证书</h2>

<p>客户端节点可能拒绝承认自签名 CA 证书有效。
对于非生产环境的部署，或运行在企业防火墙后的部署，用户可以向所有客户端分发自签名 CA 证书，
并刷新本地的有效证书列表。</p>

<p>在每个客户端上执行以下操作：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>cp ca.crt /usr/local/share/ca-certificates/kubernetes.crt
<span class="nv">$ </span><span class="nb">sudo </span>update-ca-certificates
Updating certificates <span class="k">in</span> /etc/ssl/certs...
1 added, 0 removed<span class="p">;</span> <span class="k">done</span><span class="nb">.</span>
Running hooks <span class="k">in</span> /etc/ca-certificates/update.d....
<span class="k">done</span><span class="nb">.</span>
</code></pre></div></div>

<h2 id="证书-api">证书 API</h2>

<p>您可以按照<a href="/docs/tasks/tls/managing-tls-in-a-cluster">这里</a>记录的方式，
使用 <code class="highlighter-rouge">certificates.k8s.io</code> API 来准备 x509 证书，用于认证。</p>
