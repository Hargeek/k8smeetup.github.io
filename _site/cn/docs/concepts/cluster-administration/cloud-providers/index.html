
<p>本文介绍了如何管理运行在特定云供应商上的 Kubernetes 集群。</p>

<ul id="markdown-toc">
  <li><a href="#aws" id="markdown-toc-aws">AWS</a>    <ul>
      <li><a href="#负载均衡器" id="markdown-toc-负载均衡器">负载均衡器</a></li>
    </ul>
  </li>
  <li><a href="#openstack" id="markdown-toc-openstack">OpenStack</a>    <ul>
      <li><a href="#cloudconf" id="markdown-toc-cloudconf">cloud.conf</a>        <ul>
          <li><a href="#最小配置" id="markdown-toc-最小配置">最小配置</a>            <ul>
              <li><a href="#全局配置" id="markdown-toc-全局配置">全局配置</a></li>
              <li><a href="#负载均衡器-1" id="markdown-toc-负载均衡器-1">负载均衡器</a></li>
            </ul>
          </li>
          <li><a href="#可选配置" id="markdown-toc-可选配置">可选配置</a>            <ul>
              <li><a href="#块存储" id="markdown-toc-块存储">块存储</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="aws">AWS</h1>
<p>本节介绍在 Amazon Web Services 上运行 Kubernetes 时可以使用的所有配置。</p>

<h2 id="负载均衡器">负载均衡器</h2>
<p>用户可以通过配置注解（annotations）来设置 <a href="/docs/tasks/access-application-cluster/create-external-load-balancer/">外部负载均衡器</a>，以在 AWS 中使用特定功能，如下所示：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">run</span><span class="pi">:</span> <span class="s">example</span>
  <span class="na">annotations</span><span class="pi">:</span>
     <span class="s">service.beta.kubernetes.io/aws-load-balancer-ssl-cert</span><span class="pi">:</span> <span class="s">arn:aws:acm:xx-xxxx-x:xxxxxxxxx:xxxxxxx/xxxxx-xxxx-xxxx-xxxx-xxxxxxxxx</span> <span class="c1">#replace this value</span>
     <span class="s">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</span><span class="pi">:</span> <span class="s">http</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">443</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="s">5556</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">example</span>
</code></pre></div></div>
<p>可以使用 <em>注解</em> 将不同的设置应用于 AWS 中的负载平衡器服务。 下面描述了 AWS ELB 所支持的注解：</p>

<ul>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-access-log-emit-interval</code>：用于指定访问日志的间隔。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-access-log-enabled</code>：用于在服务中启用或禁用日志访问。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name</code>：用于指定访问日志的 S3 桶名称。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix</code>：用于指定访问日志的 S3 桶前缀。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-additional-resource-tags</code>：用于在服务中指定一个逗号分隔的键值对列表，它将作为附加标签被记录在 ELB 中。 例如： <code class="highlighter-rouge">"Key1=Val1,Key2=Val2,KeyNoVal1=,KeyNoVal2"</code>。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-backend-protocol</code>：用于在服务中指定监听器后端（pod）所使用的协议。 如果指定 <code class="highlighter-rouge">http</code> （默认） 或 <code class="highlighter-rouge">https</code>， 将创建一个终止连接和解析头的 HTTPS 监听器。 如果设置为 <code class="highlighter-rouge">ssl</code> 或 <code class="highlighter-rouge">tcp</code>， 将会使用 “原生的” SSL 监听器。 如果设置为 <code class="highlighter-rouge">http</code> 且不使用 <code class="highlighter-rouge">aws-load-balancer-ssl-cert</code>，将使用 HTTP 监听器。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-ssl-cert</code>：用于在服务中请求安全监听器，其值为合法的证书 ARN（Amazon Resource Name）。 更多内容，请参考 <a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/elb-listener-config.html">ELB 监听器配置</a>。 证书 ARN 是 IAM（身份和访问管理） 或 CM（证书管理）类型的 ARN，例如 <code class="highlighter-rouge">arn:aws:acm:us-east-1:123456789012:certificate/12345678-1234-1234-1234-123456789012</code>。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-connection-draining-enabled</code>：用于在服务中启用或禁用连接耗尽（connection draining）。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-connection-draining-timeout</code>：用于在服务中指定连接耗尽超时时间。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout</code>：用于在服务中指定空闲连接超时时间。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled</code>：用于在服务中启用或禁用跨区域负载平衡。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-extra-security-groups</code>：用于在服务中指定要添加到创建的 ELB 中的其他安全组。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-internal</code>：用于在服务中表明需要内部 ELB。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-proxy-protocol</code>：用于在 ELB 上启用代理协议。 当前仅接受 <code class="highlighter-rouge">*</code> 值，也就是在所有 ELB 后端启用代理协议。 将来可能进行调整，只允许特定的后端设置代理协议。</li>
  <li><code class="highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-ssl-ports</code>：用于在服务中指定一个逗号分隔的端口列表，这些端口会使用 SSL/HTTPS 监听器。 默认为 <code class="highlighter-rouge">*</code>（全部）</li>
</ul>

<p>AWS 相关的注解信息取自 <a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/aws/aws.go">aws.go</a> 文件的注释。</p>

<h1 id="openstack">OpenStack</h1>
<p>本节介绍了使用 OpenStack 运行 Kubernetes 时所有可用的配置。</p>

<h2 id="cloudconf">cloud.conf</h2>
<p>Kubernetes 知道如何通过文件 cloud.conf 与 OpenStack 进行交互。 该文件会为 Kubernetes 提供证书和 OpenStack 认证端点的区位信息。
用户可以通过在其中指定以下信息来创建 cloud.conf 文件。</p>

<h3 id="最小配置">最小配置</h3>
<p>这是一个最小配置的例子，它涉及最常用的值：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">Global</span><span class="pi">]</span>
<span class="s">username=user</span>  
<span class="s">password=pass</span>  
<span class="s">auth-url=https://&lt;keystone_ip&gt;/identity/v3</span>  
<span class="s">tenant-id=c869168a828847f39f7f06edd7305637</span>  
<span class="s">domain-id=2a73b8f597c04551a0fdc8e95544be8a</span>

<span class="pi">[</span><span class="nv">LoadBalancer</span><span class="pi">]</span>
<span class="s">subnet-id=6937f8fa-858d-4bc9-a3a5-18d2c957166a</span>  
</code></pre></div></div>

<h4 id="全局配置">全局配置</h4>
<ul>
  <li><code class="highlighter-rouge">username</code>：指 keystone 中设置的一个合法用户的用户名。</li>
  <li><code class="highlighter-rouge">password</code>：指 keystone 中设置的一个合法用户的密码。</li>
  <li><code class="highlighter-rouge">auth-url</code>：用于认证的 keystone API 的 URL 。 在 OpenStack 控制面板上，可以在 “访问和安全（Access and Security）&gt; api 访问（API Access）&gt; 凭证（Credentials）” 路径下找到它。</li>
  <li><code class="highlighter-rouge">tenant-id</code>：用于指定要创建资源的项目 ID。</li>
  <li><code class="highlighter-rouge">domain-id</code>：用于指定用户所属的域（domain）ID。</li>
</ul>

<h4 id="负载均衡器-1">负载均衡器</h4>
<ul>
  <li><code class="highlighter-rouge">subnet-id</code>：用于指定要创建的负载均衡器所在的子网 ID。 可以在 “Network &gt; Networks” 路径下找到它。 点击相应的网络获取其子网。</li>
</ul>

<h3 id="可选配置">可选配置</h3>

<h4 id="块存储">块存储</h4>

<p>Kubernetes 利用 OpenStack 服务目录对它知道如何使用的服务进行定位，包括 Cinder 块存储服务。 然而，云供应商的配置中包含一个附加选项，可以影响块存储 API 的使用方式：</p>

<ul>
  <li><code class="highlighter-rouge">bs-version</code>：指所使用的块存储 API 版本。 其合法值为
<code class="highlighter-rouge">v1</code>、 <code class="highlighter-rouge">v2</code>、 <code class="highlighter-rouge">v3</code> 和 <code class="highlighter-rouge">auto</code>。 <code class="highlighter-rouge">auto</code> 为默认值，将使用底层 Openstack 所支持的块存储 API 的最新版本。</li>
</ul>

<p>如果在 OpenStack 上部署 Kubernetes &lt;= 1.8 的版本，同时使用路径而不是端口来区分端点（endpoints），那么可能需要显式设置 <code class="highlighter-rouge">bs-version</code> 参数。 基于路径的端点形如 <code class="highlighter-rouge">http://foo.bar/volume</code> ，而基于端口的的端点形如
<code class="highlighter-rouge">http://foo.bar:xxx</code>。</p>

<p>在使用基于路径的端点，并且 Kubernetes 使用较旧的自动检索逻辑的环境中，尝试卷卸载（detachment）会返回 <code class="highlighter-rouge">BS API version autodetection failed.</code> 错误。 为了解决这个问题，可以通过添加以下内容到云供应商配置中，来强制使用 Cinder API V2 版本。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">BlockStorage</span><span class="pi">]</span>
<span class="s">bs-version=v2</span>
</code></pre></div></div>

