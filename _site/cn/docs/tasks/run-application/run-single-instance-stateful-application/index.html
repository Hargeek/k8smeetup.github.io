
<p>本文介绍在Kubernetes中使用PersistentVolume和Deployment如何运行一个单实例有状态应用. 该应用是MySQL.</p>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#在环境中设置一个磁盘" id="markdown-toc-在环境中设置一个磁盘">在环境中设置一个磁盘</a></li>
  <li><a href="#部署mysql" id="markdown-toc-部署mysql">部署MySQL</a></li>
  <li><a href="#访问mysql实例" id="markdown-toc-访问mysql实例">访问MySQL实例</a></li>
  <li><a href="#更新" id="markdown-toc-更新">更新</a></li>
  <li><a href="#删除deployment" id="markdown-toc-删除deployment">删除deployment</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<ul>
  <li>在环境中通过磁盘创建一个PersistentVolume.</li>
  <li>创建一个MySQL Deployment.</li>
  <li>在集群内以一个已知的DNS名将MySQL暴露给其他pods.</li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>
    <p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>
  </li>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<ul>
  <li>为了数据持久性我们将在环境上通过磁盘创建一个持久卷. 环境支持的类型见这里<a href="/docs/user-guide/persistent-volumes/#types-of-persistent-volumes">here</a>. 本篇文档将介绍 <code class="highlighter-rouge">GCEPersistentDisk</code> . <code class="highlighter-rouge">GCEPersistentDisk</code>卷只能工作在Google Compute Engine平台上.</li>
</ul>

<h2 id="在环境中设置一个磁盘">在环境中设置一个磁盘</h2>

<p>你可以为有状态的应用使用任何类型的持久卷. 有关支持环境的磁盘列表，请参考持久卷类型<a href="/docs/user-guide/persistent-volumes/#types-of-persistent-volumes">Types of Persistent Volumes</a>. 对于Google Compute Engine, 请运行:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud compute disks create --size=20GB mysql-disk
</code></pre></div></div>

<p>接下来创建一个指向刚创建的 <code class="highlighter-rouge">mysql-disk</code>磁盘的PersistentVolume. 下面是一个PersistentVolume的配置文件，它指向上面创建的Compute Engine磁盘:</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/run-application/gce-volume.yaml" download="gce-volume.yaml">
                    <code>gce-volume.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('gce-volume.yaml')" title="Copy gce-volume.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="gce-volume.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-pv</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">gcePersistentDisk</span><span class="pi">:</span>
    <span class="na">pdName</span><span class="pi">:</span> <span class="s">mysql-disk</span>
    <span class="na">fsType</span><span class="pi">:</span> <span class="s">ext4</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>注意<code class="highlighter-rouge">pdName: mysql-disk</code> 这行与Compute Engine环境中的磁盘名称相匹配. 有关为其
他环境编写PersistentVolume配置文件的详细信息，请参见持久卷<a href="/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a>.</p>

<p>创建持久卷:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f https://k8s.io/docs/tasks/run-application/gce-volume.yaml
</code></pre></div></div>

<h2 id="部署mysql">部署MySQL</h2>

<p>通过创建Kubernetes Deployment并使用PersistentVolumeClaim将其连接到现已存在的PersistentVolume上来运行一个有状态的应用.  例如, 下面这个YAML文件描述了一个运行MySQL
并引用PersistentVolumeClaim的Deployment. 该文件定义了一个volume其挂载目录为/var/lib/mysql, 然后创建一个内存为20G的卷的PersistentVolumeClaim. 此申领可以通过任
何符合需求的卷来满足, 在本例中满足上面创建的卷.</p>

<p>注意: 在配置的yaml文件中定义密码的做法是不安全的. 具体安全解决方案请参考
<a href="/docs/concepts/configuration/secret/">Kubernetes Secrets</a>.</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/run-application/mysql-deployment.yaml" download="mysql-deployment.yaml">
                    <code>mysql-deployment.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('mysql-deployment.yaml')" title="Copy mysql-deployment.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="mysql-deployment.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">3306</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-pv-claim</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">20Gi</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.6</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="c1"># Use secret in real usage</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">mysql-pv-claim</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<ol>
  <li>
    <p>部署YAML文件中定义的内容:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f https://k8s.io/docs/tasks/run-application/mysql-deployment.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>展示Deployment相关信息:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe deployment mysql

 Name:                 mysql
 Namespace:            default
 CreationTimestamp:    Tue, 01 Nov 2016 11:18:45 -0700
 Labels:               app=mysql
 Annotations:          deployment.kubernetes.io/revision=1
 Selector:             app=mysql
 Replicas:             1 desired | 1 updated | 1 total | 0 available | 1 unavailable
 StrategyType:         Recreate
 MinReadySeconds:      0
 Pod Template:
   Labels:       app=mysql
   Containers:
    mysql:
     Image:      mysql:5.6
     Port:       3306/TCP
     Environment:
       MYSQL_ROOT_PASSWORD:      password
     Mounts:
       /var/lib/mysql from mysql-persistent-storage (rw)
   Volumes:
    mysql-persistent-storage:
     Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
     ClaimName:  mysql-pv-claim
     ReadOnly:   false
 Conditions:
   Type          Status  Reason
   ----          ------  ------
   Available     False   MinimumReplicasUnavailable
   Progressing   True    ReplicaSetUpdated
 OldReplicaSets:       &lt;none&gt;
 NewReplicaSet:        mysql-63082529 (1/1 replicas created)
 Events:
   FirstSeen    LastSeen    Count    From                SubobjectPath    Type        Reason            Message
   ---------    --------    -----    ----                -------------    --------    ------            -------
   33s          33s         1        {deployment-controller }             Normal      ScalingReplicaSet Scaled up replica set mysql-63082529 to 1
</code></pre></div>    </div>
  </li>
  <li>
    <p>列举出Deployment创建的pods:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -l app=mysql

 NAME                   READY     STATUS    RESTARTS   AGE
 mysql-63082529-2z3ki   1/1       Running   0          3m
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看持久卷:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pv mysql-pv

 Name:            mysql-pv
 Labels:          &lt;none&gt;
 Status:          Bound
 Claim:           default/mysql-pv-claim
 Reclaim Policy:  Retain
 Access Modes:    RWO
 Capacity:        20Gi
 Message:
 Source:
     Type:        GCEPersistentDisk (a Persistent Disk resource in Google Compute Engine)
     PDName:      mysql-disk
     FSType:      ext4
     Partition:   0
     ReadOnly:    false
 No events.
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看PersistentVolumeClaim:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pvc mysql-pv-claim

 Name:         mysql-pv-claim
 Namespace:    default
 Status:       Bound
 Volume:       mysql-pv
 Labels:       &lt;none&gt;
 Capacity:     20Gi
 Access Modes: RWO
 No events.
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="访问mysql实例">访问MySQL实例</h2>

<p>前面YAML文件中创建了一个允许集群内其他pods访问数据库的服务. 该服务中选项
<code class="highlighter-rouge">clusterIP: None</code> 让服务DNS名称直接解析为Pod的IP地址. 当在一个服务下只有一个pod
并且不打算增加pods的数量这是最好的.</p>

<p>运行MySQL客户端以连接到服务器:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run -it --rm --image=mysql:5.6 mysql-client -- mysql -h &lt;pod-ip&gt; -p &lt;password&gt;
</code></pre></div></div>

<p>此命令在集群内创建一个新的Pod并运行MySQL客户端,并通过服务将其连接到服务器.如果连接成功,你就知道有状态的MySQL database正处于运行状态.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waiting for pod default/mysql-client-274442439-zyp6i to be running, status is Pending, pod ready: false
If you don't see a command prompt, try pressing enter.

mysql&gt;
</code></pre></div></div>

<h2 id="更新">更新</h2>

<p>Deployment中镜像或其他部分同往常一样可以通过 <code class="highlighter-rouge">kubectl apply</code> 命令更新. 以下是
特定于有状态应用的一些注意事项:</p>

<ul>
  <li>不要弹性伸缩. 弹性伸缩仅适用于单实例应用. 下层的PersistentVolume仅只能挂载一个pod. 对于集群级有状态应用, 请参考StatefulSet文档
<a href="/docs/concepts/workloads/controllers/statefulset/">StatefulSet documentation</a>.</li>
  <li>在Deployment的YAML文件中使用 <code class="highlighter-rouge">strategy:</code> <code class="highlighter-rouge">type: Recreate</code> . 该选项指示Kubernetes不使用滚动升级. 滚动升级将无法工作, 由于一次不能运行多个pod. 在更新配置文件
创建一个新的pod前 <code class="highlighter-rouge">Recreate</code>策略将先停止第一个pod.</li>
</ul>

<h2 id="删除deployment">删除deployment</h2>

<p>通过名称删除部署的对象:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete deployment,svc mysql
kubectl delete pvc mysql-pv-claim
kubectl delete pv mysql-pv
</code></pre></div></div>

<p>如果使用Compute Engine磁盘，也可以使用如下命令:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcloud compute disks delete mysql-disk
</code></pre></div></div>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>
    <p>了解更多Deployment对象请参考 <a href="/docs/concepts/workloads/controllers/deployment/">Deployment objects</a>.</p>
  </li>
  <li>
    <p>了解更多Deployment应用请参考 <a href="/docs/user-guide/deploying-applications/">Deploying applications</a></p>
  </li>
  <li>
    <p>kubectl run文档请参考<a href="/docs/user-guide/kubectl/v1.6/#run">kubectl run documentation</a></p>
  </li>
  <li>
    <p>卷和持久卷请参考<a href="/docs/concepts/storage/volumes/">Volumes</a> and <a href="/docs/concepts/storage/persistent-volumes/">Persistent Volumes</a></p>
  </li>
</ul>

