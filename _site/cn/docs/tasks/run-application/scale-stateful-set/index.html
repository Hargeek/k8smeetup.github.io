
<p>本文介绍如何弹缩StatefulSet.</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#使用-kubectl-弹缩statefulsets" id="markdown-toc-使用-kubectl-弹缩statefulsets">使用 <code class="highlighter-rouge">kubectl</code> 弹缩StatefulSets</a>    <ul>
      <li><a href="#kubectl-弹缩" id="markdown-toc-kubectl-弹缩"><code class="highlighter-rouge">kubectl 弹缩</code></a></li>
      <li><a href="#可使用其他命令-kubectl-apply--kubectl-edit--kubectl-patch" id="markdown-toc-可使用其他命令-kubectl-apply--kubectl-edit--kubectl-patch">可使用其他命令: <code class="highlighter-rouge">kubectl apply</code> / <code class="highlighter-rouge">kubectl edit</code> / <code class="highlighter-rouge">kubectl patch</code></a></li>
    </ul>
  </li>
  <li><a href="#排查故障" id="markdown-toc-排查故障">排查故障</a>    <ul>
      <li><a href="#缩容工作不正常" id="markdown-toc-缩容工作不正常">缩容工作不正常</a></li>
    </ul>
  </li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>StatefulSets仅适用于Kubernetes1.5及以上版本.</li>
  <li><strong>不是所有Stateful应用都适合弹缩.</strong> 在弹缩前您的应用前. 您必须充分了解您的应用, 不适当的弹缩StatefulSet或许会造成应用自身功能的不稳定.</li>
  <li>仅当您确定该Stateful应用的集群是完全健康才可执行弹缩操作.</li>
</ul>

<h2 id="使用-kubectl-弹缩statefulsets">使用 <code class="highlighter-rouge">kubectl</code> 弹缩StatefulSets</h2>

<p>弹缩请确认 <code class="highlighter-rouge">kubectl</code> 已经升级到Kubernetes1.5及以上版本. 如果不确定, 执行 <code class="highlighter-rouge">kubectl version</code> 命令并检查使用的 <code class="highlighter-rouge">Client Version</code>.</p>

<h3 id="kubectl-弹缩"><code class="highlighter-rouge">kubectl 弹缩</code></h3>

<p>首先, 找到您想要弹缩的StatefulSet. 记住, 您需先清楚是否能弹缩该应用.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get statefulsets &lt;stateful-set-name&gt;
</code></pre></div></div>

<p>改变StatefulSet副本数量:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl scale statefulsets &lt;stateful-set-name&gt; <span class="nt">--replicas</span><span class="o">=</span>&lt;new-replicas&gt;
</code></pre></div></div>

<h3 id="可使用其他命令-kubectl-apply--kubectl-edit--kubectl-patch">可使用其他命令: <code class="highlighter-rouge">kubectl apply</code> / <code class="highlighter-rouge">kubectl edit</code> / <code class="highlighter-rouge">kubectl patch</code></h3>

<p>另外, 您可以 <a href="/docs/concepts/cluster-administration/manage-deployment/#in-place-updates-of-resources">in-place updates</a> StatefulSets.</p>

<p>如果您的StatefulSet开始由 <code class="highlighter-rouge">kubectl apply</code> 或 <code class="highlighter-rouge">kubectl create --save-config</code> 创建,更新StatefulSet manifests中的 <code class="highlighter-rouge">.spec.replicas</code>, 然后执行命令 <code class="highlighter-rouge">kubectl apply</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> &lt;stateful-set-file-updated&gt;
</code></pre></div></div>

<p>除此之外, 可以通过命令 <code class="highlighter-rouge">kubectl edit</code> 编辑该字段:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl edit statefulsets &lt;stateful-set-name&gt;
</code></pre></div></div>

<p>或使用 <code class="highlighter-rouge">kubectl patch</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch statefulsets &lt;stateful-set-name&gt; <span class="nt">-p</span> <span class="s1">'{"spec":{"replicas":&lt;new-replicas&gt;}}'</span>
</code></pre></div></div>

<h2 id="排查故障">排查故障</h2>

<h3 id="缩容工作不正常">缩容工作不正常</h3>

<p>当Stateful管理下的任何一个Pod不健康时您不能缩容该StatefulSet. 仅当Stateful下的所有Pods都处于运行和ready状态后才可缩容.</p>

<p>当一个StatefulSet的size &gt; 1, 如果有一个Pod不健康, 没有办法让Kubernetes知道是否是由于永久性故障还是瞬态(升级/维护/节点重启)导致. 如果该Pod不健康是由于永久性
故障导致, 则在不纠正该故障的情况下进行缩容可能会导致一种状态， 即StatefulSet下的Pod数量低于应正常运行的副本数. 这也许会导致StatefulSet不可用.</p>

<p>如果由于瞬态故障而导致Pod不健康,并且Pod可能再次可用，那么瞬态错误可能会干扰您对
StatefulSet的扩容/缩容操作. 一些分布式数据库在节点加入和同时离开时存在问题. 在
这些情况下，最好是在应用级别进行弹缩操作, 并且只有在您确保Stateful应用的集群是完全健康时才执行弹缩.</p>

<h2 id="whats-next">What’s next</h2>

<p>了解更多 <a href="/docs/tasks/manage-stateful-set/deleting-a-statefulset/">deleting a StatefulSet</a>.</p>

