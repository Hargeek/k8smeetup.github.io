
<p>此页面描述Pod如何使用DownwardAPIVolumeFile把自己的信息呈现给pod中运行的容器。DownwardAPIVolumeFile可以呈现pod的字段和容器字段。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#downward-api" id="markdown-toc-downward-api">Downward API</a></li>
  <li><a href="#存储pod字段" id="markdown-toc-存储pod字段">存储Pod字段</a></li>
  <li><a href="#存储容器字段" id="markdown-toc-存储容器字段">存储容器字段</a></li>
  <li><a href="#capabilities-of-the-downward-api" id="markdown-toc-capabilities-of-the-downward-api">Capabilities of the Downward API</a></li>
  <li><a href="#投射密钥到指定路径并且指定文件权限" id="markdown-toc-投射密钥到指定路径并且指定文件权限">投射密钥到指定路径并且指定文件权限</a></li>
  <li><a href="#downward-api的动机" id="markdown-toc-downward-api的动机">Downward API的动机</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>

<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="downward-api">Downward API</h2>

<p>有两种方式可以将Pod和Container字段呈现给运行中的容器：</p>

<ul>
  <li><a href="/docs/tasks/configure-pod-container/environment-variable-expose-pod-information/">环境变量</a></li>
  <li>DownwardAPIVolumeFile</li>
</ul>

<p>这两种呈现Pod和Container字段的方式都称为<em>Downward API</em>。</p>

<h2 id="存储pod字段">存储Pod字段</h2>

<p>在这个练习中，你将创建一个包含一个容器的pod。这是该pod的配置文件：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/cn/docs/tasks/inject-data-application/dapi-volume.yaml" download="dapi-volume.yaml">
                    <code>dapi-volume.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('dapi-volume.yaml')" title="Copy dapi-volume.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="dapi-volume.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes-downwardapi-volume-example</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">zone</span><span class="pi">:</span> <span class="s">us-est-coast</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">test-cluster1</span>
    <span class="na">rack</span><span class="pi">:</span> <span class="s">rack-22</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">two</span>
    <span class="na">builder</span><span class="pi">:</span> <span class="s">john-doe</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">client-container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/busybox</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">while </span><span class="no">true</span><span class="s">; do</span>
          <span class="s">if [[ -e /etc/labels ]]; then</span> 
            <span class="s">echo -en '\n\n'; cat /etc/labels; fi;</span>
          <span class="s">if [[ -e /etc/annotations ]]; then</span>
            <span class="s">echo -en '\n\n'; cat /etc/annotations; fi;</span>
          <span class="s">sleep 5;</span>
        <span class="s">done;</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">podinfo</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">podinfo</span>
      <span class="na">downwardAPI</span><span class="pi">:</span>
        <span class="na">items</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">labels"</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.labels</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">annotations"</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.annotations</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>在配置文件中，你可以看到Pod有一个<code class="highlighter-rouge">downwardAPI</code>类型的Volume，并且挂载到容器中的<code class="highlighter-rouge">/etc</code>。</p>

<p>查看<code class="highlighter-rouge">downwardAPI</code>下面的<code class="highlighter-rouge">items</code>数组。每个数组元素都是一个<a href="/docs/resources-reference/v1.8/#downwardapivolumefile-v1-core">DownwardAPIVolumeFile</a>。
第一个元素指示Pod的<code class="highlighter-rouge">metadata.labels</code>字段的值保存在名为<code class="highlighter-rouge">labels</code>的文件中。
第二个元素指示Pod的<code class="highlighter-rouge">annotations</code>字段的值保存在名为<code class="highlighter-rouge">annotations</code>的文件中。</p>

<p class="note"><strong>注意:</strong> 本示例中的字段是Pod字段，不是Pod中容器的字段。</p>

<p>创建Pod：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/cn/docs/tasks/inject-data-application/dapi-volume.yaml
</code></pre></div></div>

<p>验证Pod中的容器运行正常：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p>查看容器的日志：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs kubernetes-downwardapi-volume-example
</code></pre></div></div>

<p>输出显示<code class="highlighter-rouge">labels</code>和<code class="highlighter-rouge">annotations</code>文件的内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">cluster</span><span class="o">=</span><span class="s2">"test-cluster1"</span>
<span class="nv">rack</span><span class="o">=</span><span class="s2">"rack-22"</span>
<span class="nv">zone</span><span class="o">=</span><span class="s2">"us-est-coast"</span>

<span class="nv">build</span><span class="o">=</span><span class="s2">"two"</span>
<span class="nv">builder</span><span class="o">=</span><span class="s2">"john-doe"</span>
</code></pre></div></div>

<p>进入Pod中运行的容器，打开一个shell：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it kubernetes-downwardapi-volume-example -- sh
</code></pre></div></div>

<p>在该shell中，查看<code class="highlighter-rouge">labels</code>文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# <span class="nb">cat</span> /etc/labels
</code></pre></div></div>

<p>输出显示Pod的所有labels都已写入<code class="highlighter-rouge">labels</code>文件。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">cluster</span><span class="o">=</span><span class="s2">"test-cluster1"</span>
<span class="nv">rack</span><span class="o">=</span><span class="s2">"rack-22"</span>
<span class="nv">zone</span><span class="o">=</span><span class="s2">"us-est-coast"</span>
</code></pre></div></div>

<p>同样，查看<code class="highlighter-rouge">annotations</code>文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# <span class="nb">cat</span> /etc/annotations
</code></pre></div></div>

<p>查看<code class="highlighter-rouge">/etc</code>目录下的文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# <span class="nb">ls</span> <span class="nt">-laR</span> /etc
</code></pre></div></div>

<p>在输出中可以看到，<code class="highlighter-rouge">labels</code> 和 <code class="highlighter-rouge">annotations</code>文件都在一个临时子目录中：这个例子，<code class="highlighter-rouge">..2982_06_02_21_47_53.299460680</code>。在<code class="highlighter-rouge">/etc</code>目录中，<code class="highlighter-rouge">..data</code>是一个指向临时子目录
的符号链接。<code class="highlighter-rouge">/etc</code>目录中，<code class="highlighter-rouge">labels</code> 和 <code class="highlighter-rouge">annotations</code>也是符号链接。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drwxr-xr-x  ... Feb 6 21:47 ..2982_06_02_21_47_53.299460680
lrwxrwxrwx  ... Feb 6 21:47 ..data -&gt; ..2982_06_02_21_47_53.299460680
lrwxrwxrwx  ... Feb 6 21:47 annotations -&gt; ..data/annotations
lrwxrwxrwx  ... Feb 6 21:47 labels -&gt; ..data/labels

/etc/..2982_06_02_21_47_53.299460680:
total 8
-rw-r--r--  ... Feb  6 21:47 annotations
-rw-r--r--  ... Feb  6 21:47 labels
</code></pre></div></div>

<p>用符号链接可实现元数据的动态原子刷新；更新将写入一个新的临时目录，然后<code class="highlighter-rouge">..data</code>符号链接完成原子更新，通过使用<a href="http://man7.org/linux/man-pages/man2/rename.2.html">rename(2)</a>。</p>

<p>退出shell：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# <span class="nb">exit</span>
</code></pre></div></div>

<h2 id="存储容器字段">存储容器字段</h2>

<p>前面的练习中，你将Pod字段保存到DownwardAPIVolumeFile中。接下来这个练习，你将存储容器字段。这里是包含一个容器的pod的配置文件：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/cn/docs/tasks/inject-data-application/dapi-volume-resources.yaml" download="dapi-volume-resources.yaml">
                    <code>dapi-volume-resources.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('dapi-volume-resources.yaml')" title="Copy dapi-volume-resources.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="dapi-volume-resources.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes-downwardapi-volume-example-2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">client-container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/busybox:1.24</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">while </span><span class="no">true</span><span class="s">; do</span>
          <span class="s">echo -en '\n';</span>
          <span class="s">if [[ -e /etc/cpu_limit ]]; then</span>
            <span class="s">echo -en '\n'; cat /etc/cpu_limit; fi;</span>
          <span class="s">if [[ -e /etc/cpu_request ]]; then</span>
            <span class="s">echo -en '\n'; cat /etc/cpu_request; fi;</span>
          <span class="s">if [[ -e /etc/mem_limit ]]; then</span>
            <span class="s">echo -en '\n'; cat /etc/mem_limit; fi;</span>
          <span class="s">if [[ -e /etc/mem_request ]]; then</span>
            <span class="s">echo -en '\n'; cat /etc/mem_request; fi;</span>
          <span class="s">sleep 5;</span>
        <span class="s">done;</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">32Mi"</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">125m"</span>
        <span class="na">limits</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">64Mi"</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">podinfo</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">podinfo</span>
      <span class="na">downwardAPI</span><span class="pi">:</span>
        <span class="na">items</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cpu_limit"</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">client-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">limits.cpu</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cpu_request"</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">client-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">requests.cpu</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mem_limit"</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">client-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">limits.memory</span>
          <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">mem_request"</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">client-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">requests.memory</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>在这个配置文件中，你可以看到Pod有一个<code class="highlighter-rouge">downwardAPI</code>类型的Volume,并且挂载到容器的<code class="highlighter-rouge">/etc</code>目录。</p>

<p>查看<code class="highlighter-rouge">downwardAPI</code>下面的<code class="highlighter-rouge">items</code>数组。每个数组元素都是一个DownwardAPIVolumeFile。</p>

<p>第一个元素指定名为<code class="highlighter-rouge">client-container</code>的容器中<code class="highlighter-rouge">limits.cpu</code>字段的值应保存在名为<code class="highlighter-rouge">cpu_limit</code>的文件中。</p>

<p>创建Pod：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/cn/docs/tasks/inject-data-application/dapi-volume-resources.yaml
</code></pre></div></div>

<p>进入Pod中运行的容器，打开一个shell：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it kubernetes-downwardapi-volume-example-2 -- sh
</code></pre></div></div>

<p>在shell中，查看<code class="highlighter-rouge">cpu_limit</code>文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# <span class="nb">cat</span> /etc/cpu_limit
</code></pre></div></div>
<p>你可以使用同样的命令查看<code class="highlighter-rouge">cpu_request</code>, <code class="highlighter-rouge">mem_limit</code> 和<code class="highlighter-rouge">mem_request</code> 文件.</p>

<h2 id="capabilities-of-the-downward-api">Capabilities of the Downward API</h2>

<p>下面这些信息可以通过环境变量和DownwardAPIVolumeFiles提供给容器：</p>

<ul>
  <li>节点名称</li>
  <li>节点IP</li>
  <li>Pod名称</li>
  <li>Pod名字空间</li>
  <li>Pod IP地址</li>
  <li>Pod服务帐号名称</li>
  <li>Pod的UID</li>
  <li>容器的CPU约束</li>
  <li>容器的CPU请求值</li>
  <li>容器的内存约束</li>
  <li>容器的内存请求值</li>
</ul>

<p>此外，以下信息可通过DownwardAPIVolumeFiles获得：</p>

<ul>
  <li>Pod的标签</li>
  <li>Pod的注释</li>
</ul>

<p class="note"><strong>Note:</strong> 如果容器未指定CPU和memory limits，则Downward API默认为节点可分配值。</p>

<h2 id="投射密钥到指定路径并且指定文件权限">投射密钥到指定路径并且指定文件权限</h2>

<p>你可以将密钥投射到指定路径并且指定每个文件的访问权限。更多信息，请参阅<a href="/docs/concepts/configuration/secret/">Secrets</a>.</p>

<h2 id="downward-api的动机">Downward API的动机</h2>

<p>对于容器来说，有时候拥有自己的信息是很有用的，可避免与Kubernetes过度耦合。Downward API使得容器使用自己或者集群的信息，而不必通过Kubernetes客户端或API服务器。</p>

<p>一个例子是有一个现有的应用假定要用一个非常熟悉的环境变量来保存一个唯一标识。一种可能是给应用增加处理层，但这样是冗余和易出错的，而且它违反了低耦合的目标。更好的选择是使用Pod名称作为标识，把Pod名称注入这个环境变量中。</p>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li><a href="/docs/resources-reference/v1.8/#podspec-v1-core">PodSpec</a></li>
  <li><a href="/docs/resources-reference/v1.8/#volume-v1-core">Volume</a></li>
  <li><a href="/docs/resources-reference/v1.8/#downwardapivolumesource-v1-core">DownwardAPIVolumeSource</a></li>
  <li><a href="/docs/resources-reference/v1.8/#downwardapivolumefile-v1-core">DownwardAPIVolumeFile</a></li>
  <li><a href="/docs/resources-reference/v1.8/#resourcefieldselector-v1-core">ResourceFieldSelector</a></li>
</ul>

