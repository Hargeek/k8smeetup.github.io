
<p>本页将展示如何为Kubernetes Pod下的容器设置启动时要执行的命令及其入参。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#创建pod时为其下的容器设置启动时要执行的命令及其入参" id="markdown-toc-创建pod时为其下的容器设置启动时要执行的命令及其入参">创建Pod时为其下的容器设置启动时要执行的命令及其入参</a></li>
  <li><a href="#使用环境变量来设置入参" id="markdown-toc-使用环境变量来设置入参">使用环境变量来设置入参</a></li>
  <li><a href="#通过shell来执行命令" id="markdown-toc-通过shell来执行命令">通过shell来执行命令</a></li>
  <li><a href="#注意" id="markdown-toc-注意">注意</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>

<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="创建pod时为其下的容器设置启动时要执行的命令及其入参">创建Pod时为其下的容器设置启动时要执行的命令及其入参</h2>

<p>创建Pod时，可以为其下的容器设置启动时要执行的命令及其入参。如果要设置命令，就
填写在配置文件的<code class="highlighter-rouge">command</code>字段下，如果要设置命令的入参，就填写在配置文件的<code class="highlighter-rouge">args
</code>字段下。一旦Pod创建完成，该命令及其入参就无法再进行更改了。</p>

<p>如果在配置文件中设置了容器启动时要执行的命令及其入参，那么容器镜像中自带的命令
与入参将会被覆盖而不再执行。如果配置文件中只是设置了入参，却没有设置其对应的命
令，那么容器镜像中自带的命令会使用该新入参作为其执行时的入参。</p>

<p>本示例中，将创建一个只包含单个容器的Pod。在Pod配置文件中设置了一个命令与两个入参：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/cn/docs/tasks/inject-data-application/commands.yaml" download="commands.yaml">
                    <code>commands.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('commands.yaml')" title="Copy commands.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="commands.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">command-demo</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">purpose</span><span class="pi">:</span> <span class="s">demonstrate-command</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">command-demo-container</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">debian</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">printenv"</span><span class="pi">]</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">HOSTNAME"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">KUBERNETES_PORT"</span><span class="pi">]</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">OnFailure</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<ol>
  <li>
    <p>基于YAML文件创建一个Pod：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f https://k8s.io/docs/tasks/inject-data-application/commands.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>获取一下当前正在运行的Pods信息：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div>    </div>

    <p>查询结果显示在command-demo这个Pod下运行的容器已经启动完成</p>
  </li>
  <li>
    <p>如果要获取容器启动时执行命令的输出结果，可以通过Pod的日志进行查看</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs command-demo
</code></pre></div>    </div>

    <p>日志中显示了HOSTNAME 与KUBERNETES_PORT 这两个环境变量的值：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> command-demo
 tcp://10.3.240.1:443
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="使用环境变量来设置入参">使用环境变量来设置入参</h2>

<p>在上面的示例中，我们直接将一串字符作为命令的入参。除此之外，我们还可以
将环境变量作为命令的入参。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>env:
- name: MESSAGE
  value: "hello world"
command: ["/bin/echo"]
args: ["$(MESSAGE)"]
</code></pre></div></div>

<p>这样一来，我们就可以将那些用来设置环境变量的方法应用于设置命令的入参，其
中包括了<a href="/docs/tasks/configure-pod-container/configmap/">ConfigMaps</a>
与
<a href="/docs/concepts/configuration/secret/">Secrets</a>.</p>

<p class="note"><strong>注意：</strong> 环境变量需要加上括号，类似于<code class="highlighter-rouge">"$(VAR)"</code>。这是在<code class="highlighter-rouge">command</code> 
或 <code class="highlighter-rouge">args</code>字段使用变量的格式要求。</p>

<h2 id="通过shell来执行命令">通过shell来执行命令</h2>

<p>有时候，需要通过shell来执行命令。 例如，命令可能由多个命令组合而成，抑或包含
在一个shell脚本中。这时，就可以通过如下方式在shell中执行命令：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>command: ["/bin/sh"]
args: ["-c", "while true; do echo hello; sleep 10;done"]
</code></pre></div></div>

<h2 id="注意">注意</h2>

<p>下表给出了Docker 与 Kubernetes中对应的字段名称。</p>

<table>
  <thead>
    <tr>
      <th>Description</th>
      <th>Docker field name</th>
      <th>Kubernetes field name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>The command run by the container</td>
      <td>Entrypoint</td>
      <td>command</td>
    </tr>
    <tr>
      <td>The arguments passed to the command</td>
      <td>Cmd</td>
      <td>args</td>
    </tr>
  </tbody>
</table>

<p>如果要覆盖默认的Entrypoint 与 Cmd，需要遵循如下规则：</p>

<ul>
  <li>
    <p>如果在容器配置中没有设置<code class="highlighter-rouge">command</code> 或者 <code class="highlighter-rouge">args</code>，那么将使用Docker镜像自带的命
令及其入参。</p>
  </li>
  <li>
    <p>如果在容器配置中只设置了<code class="highlighter-rouge">command</code>但是没有设置<code class="highlighter-rouge">args</code>,那么容器启动时只会执行该
命令，Docker镜像中自带的命令及其入参会被忽略。</p>
  </li>
  <li>
    <p>如果在容器配置中只设置了<code class="highlighter-rouge">args</code>,那么Docker镜像中自带的命令会使用该新入参作为
其执行时的入参。</p>
  </li>
  <li>
    <p>如果在容器配置中同时设置了<code class="highlighter-rouge">command</code> 与 <code class="highlighter-rouge">args</code>，那么Docker镜像中自带的命令及
其入参会被忽略。容器启动时只会执行配置中设置的命令，并使用配置中设置的入参作为
命令的入参。</p>
  </li>
</ul>

<p>下表涵盖了各类设置场景：</p>

<table>
  <thead>
    <tr>
      <th>Image Entrypoint</th>
      <th>Image Cmd</th>
      <th>Container command</th>
      <th>Container args</th>
      <th>Command run</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">[/ep-1]</code></td>
      <td><code class="highlighter-rouge">[foo bar]</code></td>
      <td>&lt;not set&gt;</td>
      <td>&lt;not set&gt;</td>
      <td><code class="highlighter-rouge">[ep-1 foo bar]</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">[/ep-1]</code></td>
      <td><code class="highlighter-rouge">[foo bar]</code></td>
      <td><code class="highlighter-rouge">[/ep-2]</code></td>
      <td>&lt;not set&gt;</td>
      <td><code class="highlighter-rouge">[ep-2]</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">[/ep-1]</code></td>
      <td><code class="highlighter-rouge">[foo bar]</code></td>
      <td>&lt;not set&gt;</td>
      <td><code class="highlighter-rouge">[zoo boo]</code></td>
      <td><code class="highlighter-rouge">[ep-1 zoo boo]</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">[/ep-1]</code></td>
      <td><code class="highlighter-rouge">[foo bar]</code></td>
      <td><code class="highlighter-rouge">[/ep-2]</code></td>
      <td><code class="highlighter-rouge">[zoo boo]</code></td>
      <td><code class="highlighter-rouge">[ep-2 zoo boo]</code></td>
    </tr>
  </tbody>
</table>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>获取更多资讯可参考 <a href="/docs/user-guide/containers/">containers and commands</a>.</li>
  <li>获取更多资讯可参考 <a href="/docs/tasks/">configuring pods and containers</a>.</li>
  <li>获取更多资讯可参考 <a href="/docs/tasks/debug-application-cluster/get-shell-running-container/">running commands in a container</a>.</li>
  <li>参考 <a href="/docs/api-reference/v1.8/#container-v1-core">Container</a>.</li>
</ul>

