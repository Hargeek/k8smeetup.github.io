<p>本篇文档是介绍集群故障排查的；我们假设对于你碰到的问题，你已经排除了是由应用程序造成的。<br />
对于应用的调试，请参阅<a href="/cn/docs/tasks/debug-application-cluster/debug-application">应用故障排查指南</a>。
你也可以访问<a href="/docs/troubleshooting/">troubleshooting document</a>来获取更多的信息。</p>

<h2 id="显示出集群的节点列表">显示出集群的节点列表</h2>

<p>调试的第一步是查看所有的节点是否都正确的注册。</p>

<p>运行</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>

<p>接下来，验证你的所有节点都能够显示出来，并且都处于<code class="highlighter-rouge">Ready</code>状态。</p>

<h2 id="查看logs">查看logs</h2>

<p>现在，挖掘出集群更深层的信息就需要登录到相关的机器上。下面是相关log文件所在的位置。<br />
(注意，对于基于systemd的系统，你可能需要使用<code class="highlighter-rouge">journalctl</code>)</p>

<h3 id="master">Master</h3>

<ul>
  <li>/var/log/kube-apiserver.log - API Server, 提供API服务</li>
  <li>/var/log/kube-scheduler.log - Scheduler, 负责调度决策</li>
  <li>/var/log/kube-controller-manager.log - 管理replication controllers的控制器</li>
</ul>

<h3 id="worker-nodes">Worker Nodes</h3>

<ul>
  <li>/var/log/kubelet.log - Kubelet, 管控节点上运行的容器</li>
  <li>/var/log/kube-proxy.log - Kube Proxy, 负责服务的负载均衡</li>
</ul>

<h2 id="集群故障模式的概述">集群故障模式的概述</h2>

<p>下面是一个不完整的列表，列举了一些可能出错的场景，以及通过调整集群配置来解决相关问题的方法。</p>

<p>根本原因：</p>

<ul>
  <li>VM(s)关机</li>
  <li>集群之间，或者集群和用户之间网络分裂</li>
  <li>Kubernetes软件本身崩溃了</li>
  <li>数据丢失或者持久化存储不可用(如:GCE PD 或 AWS EBS卷)</li>
  <li>操作错误，如：Kubernetes或者应用程序配置错误</li>
</ul>

<p>具体情况:</p>

<ul>
  <li>Apiserver所在的VM关机或者apiserver崩溃
    <ul>
      <li>结果
        <ul>
          <li>不能停止，更新，或者启动新的pods，services，replication controller</li>
          <li>现有的pods和services在不依赖Kubernetes API的情况下应该能继续正常工作</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Apiserver 后端存储丢失
    <ul>
      <li>结果
        <ul>
          <li>apiserver应该不能起来</li>
          <li>kubelets将不能访问它，但是能够继续运行之前的Pods和提供相同的服务代理</li>
          <li>在apiserver重启之前，需要手动恢复或者重创apiserver的状态</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Kubernetes服务组件(节点控制器，副本控制器，调度器等等)所在的VM关机或者崩溃
    <ul>
      <li>当前，这些控制器是和apiserver共存的，它们不可用的现象是与apiserver类似的</li>
      <li>将来，这些控制器也会复制为多份，并且可能为非共存的</li>
      <li>它们没有自己的持久状态</li>
    </ul>
  </li>
  <li>单个节点(VM或者物理机)关机
    <ul>
      <li>结果
        <ul>
          <li>此节点上的所有Pods都停止运行</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>网络分裂(Network partition)
    <ul>
      <li>结果
        <ul>
          <li>partition A认为partition B中所有的节点都down掉了；partition B认为apiserver是down掉了(假定master所在的VM位于partition A内)。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Kubelet软件故障
    <ul>
      <li>结果
        <ul>
          <li>崩溃的kubelet就不能在其所在的节点上启动新的pods</li>
          <li>kubelet可能删掉pods或者不删</li>
          <li>节点被标识为非健康态</li>
          <li>副本控制器会在其它的节点上启动新的pods</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>集群操作错误
    <ul>
      <li>结果
        <ul>
          <li>丢失pods，服务等等</li>
          <li>丢失apiserver后端存储</li>
          <li>用户无法读取API</li>
          <li>等等</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>缓解措施:</p>

<ul>
  <li>措施：对于IaaS上的VMs，使用IaaS的自动VM重启功能
    <ul>
      <li>缓解：Apiserver VM关机或apiserver崩溃</li>
      <li>缓解：Kubernetes服务组件所在的VM关机或崩溃</li>
    </ul>
  </li>
  <li>措施: 对于具有apiserver+etcd的VM，使用IaaS提供的可靠的存储（例如GCE PD或者AWS EBS卷）
    <ul>
      <li>缓解：Apiserver后端存储的丢失</li>
    </ul>
  </li>
  <li>措施：使用（实验）<a href="/docs/admin/high-availability">高可用性</a>的配置
    <ul>
      <li>缓解：master VM关机或者master组件(scheduler, API server, controller-managing)崩馈
        <ul>
          <li>将容许一个或多个节点或组件同时出现故障</li>
        </ul>
      </li>
      <li>缓解：apiserver后端存储(例如etcd的数据目录)丢失
        <ul>
          <li>假定你使用了集群化的etcd。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>措施：定期的对apiserver的PDs/EBS卷进行快照
    <ul>
      <li>缓解：apiserver后端存储丢失</li>
      <li>缓解：一些操作错误的场景</li>
      <li>缓解：一些Kubernetes软件本身故障的场景</li>
    </ul>
  </li>
  <li>措施：在pods的前面使用副本控制器或服务
    <ul>
      <li>缓解：节点关机</li>
      <li>缓解：Kubelet软件故障</li>
    </ul>
  </li>
  <li>措施：应用（容器）设计成容许异常重启
    <ul>
      <li>缓解：节点关机</li>
      <li>缓解：Kubelet软件故障</li>
    </ul>
  </li>
  <li>措施：<a href="/docs/admin/multi-cluster">多个独立的集群</a>(并且避免一次性地对所有的集群进行有风险性的修改)
    <ul>
      <li>缓解：以上列出的所有情况</li>
    </ul>
  </li>
</ul>
