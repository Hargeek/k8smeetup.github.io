
<p>此任务展示如何调试StatefulSet。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#调试statefulset" id="markdown-toc-调试statefulset">调试StatefulSet</a>    <ul>
      <li><a href="#逐步初始化" id="markdown-toc-逐步初始化">逐步初始化</a></li>
    </ul>
  </li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>你需要有一个Kubernetes集群，通过必要的配置使kubectl命令行工具与您的集群进行通信。</li>
  <li>你应该有一个运行中的StatefulSet，以便用于调试。</li>
</ul>

<h2 id="调试statefulset">调试StatefulSet</h2>

<p>由于StatefulSet在创建时设置了<code class="highlighter-rouge">app=myapp</code>标签，列出仅属于该StatefulSet的所有pod时，可以使用以下命令：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>myapp
</code></pre></div></div>

<p>如果您发现列出的任何Pods长时间处于<code class="highlighter-rouge">Unknown</code> 或<code class="highlighter-rouge">Terminating</code>状态，关于如何处理它们的说明任务,请参阅<a href="/docs/tasks/manage-stateful-set/delete-pods/">删除 StatefulSet Pods</a>。您可以参考<a href="/docs/user-guide/debugging-pods-and-replication-controllers/#debugging-pods">调试 Pods</a>指南来调试StatefulSet中的各个Pod。</p>

<p>StatefulSets提供调试机制，可以使用注解来暂停所有控制器在Pod上的操作。在任何StatefulSet Pod上设置<code class="highlighter-rouge">pod.alpha.kubernetes.io/initialized</code>注解为<code class="highlighter-rouge">"false"</code>将<em>暂停</em> StatefulSet的所有操作。暂停时，StatefulSet将不执行任何伸缩操作。一旦调试钩子设置完成后，就可以在StatefulSet pod的容器内执行命令，而不会造成伸缩操作的干扰。您可以通过执行以下命令将注解设置为<code class="highlighter-rouge">"false"</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl annotate pods &lt;pod-name&gt; pod.alpha.kubernetes.io/initialized<span class="o">=</span><span class="s2">"false"</span> <span class="nt">--overwrite</span>
</code></pre></div></div>

<p>当注解设置为<code class="highlighter-rouge">"false"</code>时，StatefulSet在其Pods变得不健康或不可用时将不会响应。StatefulSet不会创建副本Pod直到每个Pod上删除注解或将注解设置为<code class="highlighter-rouge">"true"</code>。</p>

<h3 id="逐步初始化">逐步初始化</h3>

<p>创建StatefulSet之前，您可以通过使用和上文相同的注解，即将yaml文件中<code class="highlighter-rouge">.spec.template.metadata.annotations</code>里的<code class="highlighter-rouge">pod.alpha.kubernetes.io/initialized</code>字段设置为<code class="highlighter-rouge">"false"</code>，对竞态条件的StatefulSet进行调试。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-app</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">serviceName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">my-app"</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">3</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">my-app</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">pod.alpha.kubernetes.io/initialized</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
<span class="nn">...</span>
<span class="nn">...</span>
<span class="nn">...</span>

</code></pre></div></div>

<p>设置注解后，如果创建了StatefulSet，您可以等待每个Pod来验证它是否正确初始化。StatefulSet将不会创建任何后续的Pods，直到在已经创建的每个Pod上将调试注解设置为<code class="highlighter-rouge">"true"</code> (或删除)。 您可以通过执行以下命令将注解设置为<code class="highlighter-rouge">"true"</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl annotate pods &lt;pod-name&gt; pod.alpha.kubernetes.io/initialized<span class="o">=</span><span class="s2">"true"</span> <span class="nt">--overwrite</span>
</code></pre></div></div>

<h2 id="whats-next">What’s next</h2>

<p>点击链接<a href="/docs/tasks/troubleshoot/debug-init-containers/">调试init-container</a>，了解更多信息。</p>

