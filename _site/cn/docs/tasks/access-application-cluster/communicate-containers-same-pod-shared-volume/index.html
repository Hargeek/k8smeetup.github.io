
<p>本文旨在说明如何让一个 Pod 内的两个容器使用一个卷（Volume）进行通信。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#创建一个包含两个容器的-pod" id="markdown-toc-创建一个包含两个容器的-pod">创建一个包含两个容器的 Pod</a></li>
  <li><a href="#讨论" id="markdown-toc-讨论">讨论</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>

<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="创建一个包含两个容器的-pod">创建一个包含两个容器的 Pod</h2>

<p>在这个练习中，你会创建一个包含两个容器的 Pod。两个容器共享一个卷用于他们之间的通信。
Pod 的配置文件如下：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/tasks/access-application-cluster/two-container-pod.yaml" download="two-container-pod.yaml">
                    <code>two-container-pod.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('two-container-pod.yaml')" title="Copy two-container-pod.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="two-container-pod.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">two-containers</span>
<span class="na">spec</span><span class="pi">:</span>

  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>

  <span class="na">volumes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared-data</span>
    <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>

  <span class="na">containers</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-container</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared-data</span>
      <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/usr/share/nginx/html</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">debian-container</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">debian</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared-data</span>
      <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/pod-data</span>
    <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">]</span>
    <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">Hello</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">debian</span><span class="nv"> </span><span class="s">container</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/pod-data/index.html"</span><span class="pi">]</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>在配置文件中，你可以看到 Pod 有一个共享卷，名为 <code class="highlighter-rouge">shared-data</code>。</p>

<p>配置文件中的第一个容器运行了一个 nginx 服务器。共享卷的挂载路径是 <code class="highlighter-rouge">/usr/share/nginx/html</code>。
第二个容器是基于 debian 镜像的，有一个 <code class="highlighter-rouge">/pod-data</code> 的挂载路径。第二个容器运行了下面的命令然后终止。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo Hello from the debian container &gt; /pod-data/index.html
</code></pre></div></div>

<p>注意，第二个容器在 nginx 服务器的根目录下写了 <code class="highlighter-rouge">index.html</code> 文件。</p>

<p>创建一个包含两个容器的 Pod：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f https://k8s.io/docs/tasks/access-application-cluster/two-container-pod.yaml
</code></pre></div></div>

<p>查看 Pod 和容器的信息：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod two-containers --output=yaml
</code></pre></div></div>

<p>这是输出的一部分：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Pod
metadata:
  ...
  name: two-containers
  namespace: default
  ...
spec:
  ...
  containerStatuses:

  - containerID: docker://c1d8abd1 ...
    image: debian
    ...
    lastState:
      terminated:
        ...
    name: debian-container
    ...

  - containerID: docker://96c1ff2c5bb ...
    image: nginx
    ...
    name: nginx-container
    ...
    state:
      running:
    ...
</code></pre></div></div>

<p>你可以看到 debian 容器已经被终止了，而 nginx 服务器依然在运行。</p>

<p>进入 nginx 容器的 shell：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it two-containers -c nginx-container -- /bin/bash
</code></pre></div></div>

<p>在 shell 中，确认 nginx 还在运行。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@two-containers:/# ps aux
</code></pre></div></div>

<p>输出类似于这样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USER       PID  ...  STAT START   TIME COMMAND
root         1  ...  Ss   21:12   0:00 nginx: master process nginx -g daemon off;
</code></pre></div></div>

<p>回忆一下，debian 容器在 nginx 的根目录下创建了 <code class="highlighter-rouge">index.html</code> 文件。
使用 <code class="highlighter-rouge">curl</code> 向 nginx 服务器发送一个 GET 请求：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@two-containers:/# apt-get update
root@two-containers:/# apt-get install curl
root@two-containers:/# curl localhost
</code></pre></div></div>

<p>输出表示 nginx 提供了 debian 容器写的页面：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello from the debian container
</code></pre></div></div>

<h2 id="讨论">讨论</h2>

<p>Pod 能有多个容器的主要原因是为了支持辅助应用（helper applications），以协助主应用（primary application）。
辅助应用的典型例子是数据抽取，数据推送和代理。辅助应用和主应用经常需要相互通信。
就如这个练习所示，通信通常是通过共享文件系统完成的，或者，也通过回环网络接口 localhost 完成。
举个网络接口的例子，web 服务器带有一个协助程序用于拉取 Git 仓库的更新。</p>

<p>在本练习中的卷为 Pod 生命周期中的容器相互通信提供了一种方法。如果 Pod 被删除或者重建了，
任何共享卷中的数据都会丢失。</p>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>
    <p>更多学习内容
<a href="http://blog.kubernetes.io/2015/06/the-distributed-system-toolkit-patterns.html">混合容器的方式</a>。</p>
  </li>
  <li>
    <p>学习 <a href="http://www.slideshare.net/Docker/slideshare-burns">模块化架构的混合容器</a>。</p>
  </li>
  <li>
    <p>参见 <a href="/docs/tasks/configure-pod-container/configure-volume-storage/">配置一个使用存储卷的 Pod</a>。</p>
  </li>
  <li>
    <p>参见 <a href="/docs/api-reference/v1.8/#volume-v1-core">卷</a>。</p>
  </li>
  <li>
    <p>参见 <a href="/docs/api-reference/v1.8/#pod-v1-core">Pod</a>.</p>
  </li>
</ul>

