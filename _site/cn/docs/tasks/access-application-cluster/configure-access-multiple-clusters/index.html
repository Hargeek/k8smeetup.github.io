
<p>本文展示如何使用配置文件来配置对多个集群的访问。 在将集群、用户和上下文定义在一个或多个配置文件中之后，用户可以使用 <code class="highlighter-rouge">kubectl config use-context</code> 命令快速地在集群之间进行切换。</p>

<p class="note"><strong>注意：</strong> 用于配置集群访问的文件有时被称为 <em>kubeconfig 文件</em>。
这是一种引用配置文件的通用方式，并不意味着存在一个名为 <code class="highlighter-rouge">kubeconfig</code> 的文件。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#定义集群用户和上下文" id="markdown-toc-定义集群用户和上下文">定义集群、用户和上下文</a></li>
  <li><a href="#创建第二个配置文件" id="markdown-toc-创建第二个配置文件">创建第二个配置文件</a></li>
  <li><a href="#设置-kubeconfig-环境变量" id="markdown-toc-设置-kubeconfig-环境变量">设置 KUBECONFIG 环境变量</a></li>
  <li><a href="#探索-homekube-目录" id="markdown-toc-探索-homekube-目录">探索 $HOME/.kube 目录</a></li>
  <li><a href="#将-homekubeconfig-追加到-kubeconfig-环境变量中" id="markdown-toc-将-homekubeconfig-追加到-kubeconfig-环境变量中">将 $HOME/.kube/config 追加到 KUBECONFIG 环境变量中</a></li>
  <li><a href="#清理" id="markdown-toc-清理">清理</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>需要安装 <a href="/docs/tasks/tools/install-kubectl/"><code class="highlighter-rouge">kubectl</code></a> 命令行工具。</p>

<h2 id="定义集群用户和上下文">定义集群、用户和上下文</h2>

<p>假设用户有两个集群，一个用于正式开发工作，一个用于其它临时用途（scratch）。
在 <code class="highlighter-rouge">development</code> 集群中，前端开发者在名为 <code class="highlighter-rouge">frontend</code> 的名字空间下工作，
存储开发者在名为 <code class="highlighter-rouge">storage</code> 的名字空间下工作。 在 <code class="highlighter-rouge">scratch</code> 集群中，
开发人员可能在默认名字空间下工作，也可能视情况创建附加的名字空间。 访问开发集群需要通过证书进行认证。 访问其它临时用途的集群需要通过用户名和密码进行认证。</p>

<p>创建名为 <code class="highlighter-rouge">config-exercise</code> 的目录。 在
<code class="highlighter-rouge">config-exercise</code> 目录中，创建名为 <code class="highlighter-rouge">config-demo</code> 的文件，其内容为：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>

<span class="na">clusters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">development</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">scratch</span>

<span class="na">users</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">developer</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">experimenter</span>

<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-frontend</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-storage</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">exp-scratch</span>
</code></pre></div></div>

<p>配置文件描述了集群、用户名和上下文。  <code class="highlighter-rouge">config-demo</code> 文件中含有描述两个集群、两个用户和三个上下文的框架。</p>

<p>进入 <code class="highlighter-rouge">config-exercise</code> 目录。 输入以下命令，将群集详细信息添加到配置文件中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-cluster development <span class="nt">--server</span><span class="o">=</span>https://1.2.3.4 <span class="nt">--certificate-authority</span><span class="o">=</span>fake-ca-file
kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-cluster scratch <span class="nt">--server</span><span class="o">=</span>https://5.6.7.8 <span class="nt">--insecure-skip-tls-verify</span>
</code></pre></div></div>

<p>将用户详细信息添加到配置文件中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-credentials developer <span class="nt">--client-certificate</span><span class="o">=</span>fake-cert-file <span class="nt">--client-key</span><span class="o">=</span>fake-key-seefile
kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-credentials experimenter <span class="nt">--username</span><span class="o">=</span>exp <span class="nt">--password</span><span class="o">=</span>some-password
</code></pre></div></div>

<p>将上下文详细信息添加到配置文件中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-context dev-frontend <span class="nt">--cluster</span><span class="o">=</span>development <span class="nt">--namespace</span><span class="o">=</span>frontend <span class="nt">--user</span><span class="o">=</span>developer
kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-context dev-storage <span class="nt">--cluster</span><span class="o">=</span>development <span class="nt">--namespace</span><span class="o">=</span>storage <span class="nt">--user</span><span class="o">=</span>developer
kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo set-context exp-scratch <span class="nt">--cluster</span><span class="o">=</span>scratch <span class="nt">--namespace</span><span class="o">=</span>default <span class="nt">--user</span><span class="o">=</span>experimenter
</code></pre></div></div>

<p>打开 <code class="highlighter-rouge">config-demo</code> 文件查看添加的详细信息。 也可以使用 <code class="highlighter-rouge">config view</code> 命令进行查看：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo view
</code></pre></div></div>

<p>输出展示了两个集群、两个用户和三个上下文：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">clusters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
    <span class="na">certificate-authority</span><span class="pi">:</span> <span class="s">fake-ca-file</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://1.2.3.4</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">development</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
    <span class="na">insecure-skip-tls-verify</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://5.6.7.8</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">scratch</span>
<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">frontend</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-frontend</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">storage</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-storage</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">scratch</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">experimenter</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">exp-scratch</span>
<span class="na">current-context</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">users</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">client-certificate</span><span class="pi">:</span> <span class="s">fake-cert-file</span>
    <span class="na">client-key</span><span class="pi">:</span> <span class="s">fake-key-file</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">experimenter</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">some-password</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">exp</span>
</code></pre></div></div>

<p>每个上下文包含三部分（集群、用户和名字空间），例如，
<code class="highlighter-rouge">dev-frontend</code> 上下文表明：使用 <code class="highlighter-rouge">developer</code> 用户的凭证来访问 <code class="highlighter-rouge">development</code> 集群的 <code class="highlighter-rouge">frontend</code> 名字空间。</p>

<p>设置当前上下文：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo use-context dev-frontend
</code></pre></div></div>

<p>现在当输入 <code class="highlighter-rouge">kubectl</code> 命令时，相应动作会应用于 <code class="highlighter-rouge">dev-frontend</code> 上下文中所列的集群和名字空间，同时，命令会使用 <code class="highlighter-rouge">dev-frontend</code> 上下文中所列用户的凭证。</p>

<p>使用 <code class="highlighter-rouge">--minify</code> 参数，来查看与当前上下文相关联的配置信息。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo view <span class="nt">--minify</span>
</code></pre></div></div>

<p>输出结果展示了 <code class="highlighter-rouge">dev-frontend</code> 上下文相关的配置信息：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">clusters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">cluster</span><span class="pi">:</span>
    <span class="na">certificate-authority</span><span class="pi">:</span> <span class="s">fake-ca-file</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://1.2.3.4</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">development</span>
<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">frontend</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-frontend</span>
<span class="na">current-context</span><span class="pi">:</span> <span class="s">dev-frontend</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>
<span class="na">users</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">user</span><span class="pi">:</span>
    <span class="na">client-certificate</span><span class="pi">:</span> <span class="s">fake-cert-file</span>
    <span class="na">client-key</span><span class="pi">:</span> <span class="s">fake-key-file</span>
</code></pre></div></div>

<p>现在假设用户希望在其它临时用途集群中工作一段时间。</p>

<p>将当前上下文更改为 <code class="highlighter-rouge">exp-scratch</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo use-context exp-scratch
</code></pre></div></div>

<p>现在用户 <code class="highlighter-rouge">kubectl</code> 下达的任何命令都将应用于 <code class="highlighter-rouge">scratch</code> 集群的默认名字空间。 同时，命令会使用 <code class="highlighter-rouge">exp-scratch</code> 上下文中所列用户的凭证。</p>

<p>查看更新后的当前上下文 <code class="highlighter-rouge">exp-scratch</code> 相关的配置：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo view <span class="nt">--minify</span>
</code></pre></div></div>

<p>最后，假设用户希望在 <code class="highlighter-rouge">development</code> 集群中的 <code class="highlighter-rouge">storage</code> 名字空间下工作一段时间。</p>

<p>将当前上下文更改为 <code class="highlighter-rouge">dev-storage</code>：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo use-context dev-storage
</code></pre></div></div>

<p>查看更新后的当前上下文 <code class="highlighter-rouge">dev-storage</code> 相关的配置：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config <span class="nt">--kubeconfig</span><span class="o">=</span>config-demo view <span class="nt">--minify</span>
</code></pre></div></div>

<h2 id="创建第二个配置文件">创建第二个配置文件</h2>

<p>在 <code class="highlighter-rouge">config-exercise</code> 目录中，创建名为 <code class="highlighter-rouge">config-demo-2</code> 的文件，其中包含以下内容：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Config</span>
<span class="na">preferences</span><span class="pi">:</span> <span class="pi">{}</span>

<span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">ramp</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-ramp-up</span>
</code></pre></div></div>

<p>上述配置文件定义了一个新的上下文，名为 <code class="highlighter-rouge">dev-ramp-up</code>。</p>

<h2 id="设置-kubeconfig-环境变量">设置 KUBECONFIG 环境变量</h2>

<p>查看是否有名为 <code class="highlighter-rouge">KUBECONFIG</code> 的环境变量。 如有，保存 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量当前的值，以便稍后恢复。
例如，在 Linux 中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export  </span><span class="nv">KUBECONFIG_SAVED</span><span class="o">=</span><span class="nv">$KUBECONFIG</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">KUBECONFIG</code> 环境变量是配置文件路径的列表，该列表在 Linux 和 Mac 中以冒号分隔，在 Windows 中以分号分隔。 如果有 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量，请熟悉列表中的配置文件。</p>

<p>临时添加两条路径到 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量中。 例如，在 Linux 中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export  </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$KUBECONFIG</span>:config-demo:config-demo-2
</code></pre></div></div>

<p>在 <code class="highlighter-rouge">config-exercise</code> 目录中输入以下命令：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config view
</code></pre></div></div>

<p>输出展示了 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量中所列举的所有文件合并后的信息。 特别地， 注意合并信息中包含来自 <code class="highlighter-rouge">config-demo-2</code> 文件的 <code class="highlighter-rouge">dev-ramp-up</code> 上下文和来自 <code class="highlighter-rouge">config-demo</code> 文件的三个上下文：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">contexts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">frontend</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-frontend</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">ramp</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-ramp-up</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">development</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">storage</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">developer</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-storage</span>
<span class="pi">-</span> <span class="na">context</span><span class="pi">:</span>
    <span class="na">cluster</span><span class="pi">:</span> <span class="s">scratch</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">experimenter</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">exp-scratch</span>
</code></pre></div></div>

<p>更多关于 kubeconfig 文件如何合并的信息，请参考
<a href="/docs/concepts/configuration/organize-cluster-access-kubeconfig/">使用 kubeconfig 文件组织集群访问</a></p>

<h2 id="探索-homekube-目录">探索 $HOME/.kube 目录</h2>

<p>如果用户已经拥有一个集群，可以使用 <code class="highlighter-rouge">kubectl</code> 与集群进行交互。 那么很可能在 <code class="highlighter-rouge">$HOME/.kube</code> 目录下有一个名为 <code class="highlighter-rouge">config</code> 的文件。</p>

<p>进入 <code class="highlighter-rouge">$HOME/.kube</code> 目录， 看看那里有什么文件。 通常会有一个名为
<code class="highlighter-rouge">config</code> 的文件，目录中可能还有其他配置文件。 请简单地熟悉这些文件的内容。</p>

<h2 id="将-homekubeconfig-追加到-kubeconfig-环境变量中">将 $HOME/.kube/config 追加到 KUBECONFIG 环境变量中</h2>

<p>如果有 <code class="highlighter-rouge">$HOME/.kube/config</code> 文件，并且还未列在 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量中，
那么现在将它追加到 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量中。
例如，在 Linux 中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$KUBECONFIG</span>:<span class="nv">$HOME</span>/.kube/config
</code></pre></div></div>

<p>在配置练习目录中输入以下命令，来查看当前 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量中列举的所有文件合并后的配置信息：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config view
</code></pre></div></div>

<h2 id="清理">清理</h2>

<p>将 <code class="highlighter-rouge">KUBECONFIG</code> 环境变量还原为原始值。 例如，在 Linux 中：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$KUBECONFIG_SAVED</span>
</code></pre></div></div>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li><a href="/docs/concepts/configuration/organize-cluster-access-kubeconfig/">使用 kubeconfig 文件组织集群访问</a></li>
  <li><a href="/docs/user-guide/kubectl/v1.8/">kubectl 配置</a></li>
</ul>

