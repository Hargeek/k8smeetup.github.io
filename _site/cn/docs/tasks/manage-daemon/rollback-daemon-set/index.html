
<p>本文展示了如何对 DaemonSet 执行回滚。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#对-daemonset-执行回滚" id="markdown-toc-对-daemonset-执行回滚">对 DaemonSet 执行回滚</a>    <ul>
      <li><a href="#步骤-1-找到想要-daemonset-回滚到的历史版本revision" id="markdown-toc-步骤-1-找到想要-daemonset-回滚到的历史版本revision">步骤 1： 找到想要 DaemonSet 回滚到的历史版本（revision）</a></li>
      <li><a href="#步骤-2-回滚到指定版本" id="markdown-toc-步骤-2-回滚到指定版本">步骤 2： 回滚到指定版本</a></li>
      <li><a href="#步骤-3-观察-daemonset-回滚进度" id="markdown-toc-步骤-3-观察-daemonset-回滚进度">步骤 3： 观察 DaemonSet 回滚进度</a></li>
    </ul>
  </li>
  <li><a href="#理解-daemonset-版本" id="markdown-toc-理解-daemonset-版本">理解 DaemonSet 版本</a></li>
  <li><a href="#故障排除" id="markdown-toc-故障排除">故障排除</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>DaemonSet 滚动升级历史和 DaemonSet 回滚特性仅在 Kubernetes 1.7 及以后版本的 <code class="highlighter-rouge">kubectl</code> 中支持。</li>
  <li>确保您了解如何 <a href="/docs/tasks/manage-daemon/update-daemon-set/">对 DaemonSet 执行滚动升级</a>。</li>
</ul>

<h2 id="对-daemonset-执行回滚">对 DaemonSet 执行回滚</h2>

<h3 id="步骤-1-找到想要-daemonset-回滚到的历史版本revision">步骤 1： 找到想要 DaemonSet 回滚到的历史版本（revision）</h3>

<p>如果只想回滚到最后一个版本，可以跳过这一步。</p>

<p>列出 DaemonSet 的所有版本：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout <span class="nb">history </span>daemonset &lt;daemonset-name&gt;
</code></pre></div></div>

<p>该命令返回 DaemonSet 版本列表：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemonsets <span class="s2">"&lt;daemonset-name&gt;"</span>
REVISION        CHANGE-CAUSE
1               ...
2               ...
...
</code></pre></div></div>

<ul>
  <li>在创建时，DaemonSet 的变化原因从 <code class="highlighter-rouge">kubernetes.io/change-cause</code> 注解（annotation）复制到其版本中。 用户可以在 <code class="highlighter-rouge">kubectl</code> 中指定 <code class="highlighter-rouge">--record=true</code> ，将执行的命令记录在变化原因注解中。</li>
</ul>

<p>执行以下命令，来查看指定版本的详细信息：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout <span class="nb">history </span>daemonset &lt;daemonset-name&gt; <span class="nt">--revision</span><span class="o">=</span>1
</code></pre></div></div>

<p>该命令返回相应版本的详细信息：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemonsets <span class="s2">"&lt;daemonset-name&gt;"</span> with revision <span class="c">#1</span>
Pod Template:
Labels:       <span class="nv">foo</span><span class="o">=</span>bar
Containers:
app:
 Image:       ...
 Port:        ...
 Environment: ...
 Mounts:      ...
Volumes:       ...
</code></pre></div></div>

<h3 id="步骤-2-回滚到指定版本">步骤 2： 回滚到指定版本</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在 --to-revision 中指定您从步骤 1 中获取的版本序号</span>
kubectl rollout undo daemonset &lt;daemonset-name&gt; <span class="nt">--to-revision</span><span class="o">=</span>&lt;revision&gt;
</code></pre></div></div>

<p>如果成功，命令会返回：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemonset <span class="s2">"&lt;daemonset-name&gt;"</span> rolled back
</code></pre></div></div>

<p>如果 <code class="highlighter-rouge">--to-revision</code> 参数未指定，将选中最近的版本。</p>

<h3 id="步骤-3-观察-daemonset-回滚进度">步骤 3： 观察 DaemonSet 回滚进度</h3>

<p><code class="highlighter-rouge">kubectl rollout undo daemonset</code> 向服务器表明启动 DaemonSet 回滚。 真正的回滚是在服务器端异步完成的。</p>

<p>执行以下命令，来观察 DaemonSet 回滚进度：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout status ds/&lt;daemonset-name&gt; 
</code></pre></div></div>

<p>回滚完成时，输出形如：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemonset <span class="s2">"&lt;daemonset-name&gt;"</span> successfully rolled out
</code></pre></div></div>

<h2 id="理解-daemonset-版本">理解 DaemonSet 版本</h2>

<p>在前面的 <code class="highlighter-rouge">kubectl rollout history</code> 步骤中，您获得了一个版本列表，每个版本都存储在名为
 <code class="highlighter-rouge">ControllerRevision</code> 的资源中。 <code class="highlighter-rouge">ControllerRevision</code> 仅在 Kubernetes 1.7 及以后的版本中可用。</p>

<p>查找原始的版本资源，来查看每个版本中存储了什么内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get controllerrevision <span class="nt">-l</span> &lt;daemonset-selector-key&gt;<span class="o">=</span>&lt;daemonset-selector-value&gt;
</code></pre></div></div>

<p>该命令返回 <code class="highlighter-rouge">ControllerRevisions</code> 列表：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                               CONTROLLER                     REVISION   AGE
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     1          1h
&lt;daemonset-name&gt;-&lt;revision-hash&gt;   DaemonSet/&lt;daemonset-name&gt;     2          1h
</code></pre></div></div>

<p>每个 <code class="highlighter-rouge">ControllerRevision</code> 中存储了相应 DaemonSet 版本的注解和模板。</p>

<p><code class="highlighter-rouge">kubectl rollout undo</code> 采用特定 <code class="highlighter-rouge">ControllerRevision</code> ，并用
<code class="highlighter-rouge">ControllerRevision</code> 中存储的模板代替 DaemonSet 的模板。
<code class="highlighter-rouge">kubectl rollout undo</code> 相当于通过其他命令（如 <code class="highlighter-rouge">kubectl edit</code> 或 <code class="highlighter-rouge">kubectl apply</code>）将 DaemonSet 模板更新至先前的版本。</p>

<p>注意 DaemonSet 版本只会向前滚动。 也就是说，回滚完成后，所回滚到的 <code class="highlighter-rouge">ControllerRevision</code> 版本号 (<code class="highlighter-rouge">.revision</code> 字段) 会增加。 例如，如果用户在系统中有版本 1 和版本 2，并从版本 2 回滚到版本 1 ，带有 <code class="highlighter-rouge">.revision: 1</code> 的<code class="highlighter-rouge">ControllerRevision</code> 将变为 <code class="highlighter-rouge">.revision: 3</code>。</p>

<h2 id="故障排除">故障排除</h2>

<ul>
  <li>查看 <a href="/docs/tasks/manage-daemon/update-daemon-set/#troubleshooting">DaemonSet 滚动升级故障排除</a>。</li>
</ul>

