<ul id="markdown-toc">
  <li><a href="#警告" id="markdown-toc-警告">警告</a></li>
  <li><a href="#前提条件" id="markdown-toc-前提条件">前提条件</a></li>
  <li><a href="#启动一个集群" id="markdown-toc-启动一个集群">启动一个集群</a></li>
  <li><a href="#支持级别" id="markdown-toc-支持级别">支持级别</a></li>
</ul>

<h2 id="警告">警告</h2>

<p>本文档适用于Kubernetes 1.1.0，目前已经被<a href="https://github.com/kubernetes/website/issues/1613">废弃</a>。相关内容请参阅最新版<a href="/docs/getting-started-guides/kubeadm/">指南</a>。</p>

<h2 id="前提条件">前提条件</h2>

<p>在CentOS上部署和配置Kubernetes，您需要在集群中拥有一台机器作为master节点，并拥有至少一台运行CentOS 7系统的主机作为集群节点（node）。</p>

<h2 id="启动一个集群">启动一个集群</h2>

<p>本文档是一篇基于CentOS系统部署和配置Kubernetes的入门指南，内容涵盖一个手工的配置，以便于您了解所有的底层软件包、服务以及端口等信息。</p>

<p>Kubernetes由一系列服务构成，包括kube-apiserver、kube-scheduler、kube-controller-manager、kubelet以及kube-proxy等。这些服务由systemd管理，配置集中位于/etc/kubernetes。我们将在集群中的不同主机上部署不同的服务。其中，第一台主机，即centos-master，将被部署成为Kubernetes集群中的master节点。这台主机上将运行kube-apiserver、kube-controller-manager和kube-scheduler。 此外，master节点还将运行 <em>etcd</em>。集群中剩余的主机，即centos-minion-n节点，将运行kubelet、proxy、cadvisor和docker。</p>

<p>集群中的所有节点将运行flanneld来构建网络（networking overlay）。</p>

<p><strong>系统信息：</strong></p>

<p>主机：</p>

<p>请使用您真实环境中的信息替换以下配置中的各个主机IP</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">centos</span>-<span class="n">master</span> = <span class="m">192</span>.<span class="m">168</span>.<span class="m">121</span>.<span class="m">9</span>
<span class="n">centos</span>-<span class="n">minion</span>-<span class="m">1</span> = <span class="m">192</span>.<span class="m">168</span>.<span class="m">121</span>.<span class="m">65</span>
<span class="n">centos</span>-<span class="n">minion</span>-<span class="m">2</span> = <span class="m">192</span>.<span class="m">168</span>.<span class="m">121</span>.<span class="m">66</span>
<span class="n">centos</span>-<span class="n">minion</span>-<span class="m">3</span> = <span class="m">192</span>.<span class="m">168</span>.<span class="m">121</span>.<span class="m">67</span>
</code></pre></div></div>

<p><strong>配置主机环境：</strong></p>

<ul>
  <li>在集群所有节点上——centos-{master,minion-n}，创建包含以下配置信息的/etc/yum.repos.d/virt7-docker-common-release.repo文件。</li>
</ul>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">virt7</span>-<span class="n">docker</span>-<span class="n">common</span>-<span class="n">release</span>]
<span class="n">name</span>=<span class="n">virt7</span>-<span class="n">docker</span>-<span class="n">common</span>-<span class="n">release</span>
<span class="n">baseurl</span>=<span class="n">http</span>://<span class="n">cbs</span>.<span class="n">centos</span>.<span class="n">org</span>/<span class="n">repos</span>/<span class="n">virt7</span>-<span class="n">docker</span>-<span class="n">common</span>-<span class="n">release</span>/<span class="n">x86_64</span>/<span class="n">os</span>/
<span class="n">gpgcheck</span>=<span class="m">0</span>
</code></pre></div></div>

<ul>
  <li>在集群所有节点上——centos-{master,minion-n}，安装Kubernetes、etcd和flanneld。这一过程也将同时在节点上安装docker和cadvisor。</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> install <span class="nt">--enablerepo</span><span class="o">=</span>virt7-docker-common-release kubernetes etcd flannel
</code></pre></div></div>

<ul>
  <li>将master节点和其他节点的主机名——IP映射添加到所有集群节点的/etc/hosts文件中（如果主机名已经在DNS中记录，则可略过此步）</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"192.168.121.9    centos-master
192.168.121.65    centos-minion-1
192.168.121.66  centos-minion-2
192.168.121.67  centos-minion-3"</span> <span class="o">&gt;&gt;</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>编辑/etc/kubernetes/config文件以保证在集群所有主机上都包含以下内容：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># logging to stderr意为从systemd journal获取日志</span>
<span class="nv">KUBE_LOGTOSTDERR</span><span class="o">=</span><span class="s2">"--logtostderr=true"</span>

<span class="c"># journal消息级别, 0代表debug</span>
<span class="nv">KUBE_LOG_LEVEL</span><span class="o">=</span><span class="s2">"--v=0"</span>

<span class="c"># 是否允许集群运行privileged docker containers</span>
<span class="nv">KUBE_ALLOW_PRIV</span><span class="o">=</span><span class="s2">"--allow-privileged=false"</span>

<span class="c"># 配置replication conrtoller和scheduler所需的kube-apiserver地址</span>
<span class="nv">KUBE_MASTER</span><span class="o">=</span><span class="s2">"--master=http://centos-master:8080"</span>
</code></pre></div></div>

<ul>
  <li>由于docker与一些防火墙规则不兼容，需要在master节点及其他集群节点上禁用防火墙。在CentOS系统上，需要首先禁用SELinux，进而才能禁用防火墙。</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>setenforce 0
systemctl disable iptables-services firewalld
systemctl stop iptables-services firewalld
</code></pre></div></div>

<p><strong>配置master节点上的Kubernetes服务</strong></p>

<ul>
  <li>编辑/etc/etcd/etcd.conf文件内容如下：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [member]</span>
<span class="nv">ETCD_NAME</span><span class="o">=</span>default
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/default.etcd"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"http://0.0.0.0:2379"</span>

<span class="c">#[cluster]</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"http://0.0.0.0:2379"</span>
</code></pre></div></div>

<ul>
  <li>编辑/etc/kubernetes/apiserver文件内容如下：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 本地服务器监听地址</span>
<span class="nv">KUBE_API_ADDRESS</span><span class="o">=</span><span class="s2">"--address=0.0.0.0"</span>

<span class="c"># 本地服务器监听端口</span>
<span class="nv">KUBE_API_PORT</span><span class="o">=</span><span class="s2">"--port=8080"</span>

<span class="c"># Kubelet监听端口</span>
<span class="nv">KUBELET_PORT</span><span class="o">=</span><span class="s2">"--kubelet-port=10250"</span>

<span class="c"># 以逗号间隔的etcd集群中各个节点的地址</span>
<span class="nv">KUBE_ETCD_SERVERS</span><span class="o">=</span><span class="s2">"--etcd-servers=http://centos-master:2379"</span>

<span class="c"># Kubernetes服务IP地址网段</span>
<span class="nv">KUBE_SERVICE_ADDRESSES</span><span class="o">=</span><span class="s2">"--service-cluster-ip-range=10.254.0.0/16"</span>

<span class="c"># 请添加您需要的Kubernetes API Server启动参数</span>
<span class="nv">KUBE_API_ARGS</span><span class="o">=</span><span class="s2">""</span>
</code></pre></div></div>

<ul>
  <li>启动ETCD并保存master节点的网络设置（network overlay configuration）：
<strong>警告</strong> 请根据您的真实环境配置网络信息！在本文环境中，<code class="highlighter-rouge">172.30.0.0/16</code>网段是可用的。</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start etcd
etcdctl mkdir /kube-centos/network
etcdctl mk /kube-centos/network/config <span class="s2">"{ </span><span class="se">\"</span><span class="s2">Network</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">172.30.0.0/16</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">SubnetLen</span><span class="se">\"</span><span class="s2">: 24, </span><span class="se">\"</span><span class="s2">Backend</span><span class="se">\"</span><span class="s2">: { </span><span class="se">\"</span><span class="s2">Type</span><span class="se">\"</span><span class="s2">: </span><span class="se">\"</span><span class="s2">vxlan</span><span class="se">\"</span><span class="s2"> } }"</span>
</code></pre></div></div>

<ul>
  <li>在master节点上配置/etc/sysconfig/flanneld文件使用flannel覆盖Docker网络 (需要在其他集群节点上完成相同配置，详见下文):</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Flanneld配置选项</span>

<span class="c"># etcd url地址，指向运行etcd的服务器</span>
<span class="nv">FLANNEL_ETCD_ENDPOINTS</span><span class="o">=</span><span class="s2">"http://centos-master:2379"</span>

<span class="c"># etcd配置秘钥，即flannel查询的配置秘钥</span>
<span class="c"># 用于网段分配</span>
<span class="nv">FLANNEL_ETCD_PREFIX</span><span class="o">=</span><span class="s2">"/kube-centos/network"</span>

<span class="c"># 其它需要的Flannel启动参数</span>
<span class="c">#FLANNEL_OPTIONS=""</span>
</code></pre></div></div>

<ul>
  <li>在master节点上启动相关服务：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>SERVICES <span class="k">in </span>etcd kube-apiserver kube-controller-manager kube-scheduler flanneld<span class="p">;</span> <span class="k">do
    </span>systemctl restart <span class="nv">$SERVICES</span>
    systemctl <span class="nb">enable</span> <span class="nv">$SERVICES</span>
    systemctl status <span class="nv">$SERVICES</span>
<span class="k">done</span>
</code></pre></div></div>

<p><strong>在集群其他节点上配置Kubernetes服务</strong></p>

<p><strong><em>我们需要在集群其他节点上配置kubelet，启动kubelet和proxy服务</em></strong></p>

<ul>
  <li>编辑/etc/kubernetes/kubelet文件内容如下：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># info server的服务地址</span>
<span class="nv">KUBELET_ADDRESS</span><span class="o">=</span><span class="s2">"--address=0.0.0.0"</span>

<span class="c"># info server的监听端口</span>
<span class="nv">KUBELET_PORT</span><span class="o">=</span><span class="s2">"--port=10250"</span>

<span class="c"># 本字段可以设置空值以使用真实的主机名</span>
<span class="c"># 注意节点序号（n）</span>
<span class="nv">KUBELET_HOSTNAME</span><span class="o">=</span><span class="s2">"--hostname-override=centos-minion-n"</span>

<span class="c"># api-server地址</span>
<span class="nv">KUBELET_API_SERVER</span><span class="o">=</span><span class="s2">"--api-servers=http://centos-master:8080"</span>

<span class="c"># 添加您所需要的Kubelet参数</span>
<span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">""</span>
</code></pre></div></div>

<ul>
  <li>在所有节点上配置/etc/sysconfig/flanneld文件设置使用flannel覆盖Docker网络：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Flanneld配置选项</span>

<span class="c"># etcd url地址，指向运行etcd的服务器</span>
<span class="nv">FLANNEL_ETCD_ENDPOINTS</span><span class="o">=</span><span class="s2">"http://centos-master:2379"</span>

<span class="c"># etcd配置秘钥，即flannel查询的配置秘钥</span>
<span class="c"># 用于网段分配</span>
<span class="nv">FLANNEL_ETCD_PREFIX</span><span class="o">=</span><span class="s2">"/kube-centos/network"</span>

<span class="c"># 其他需要配置的选项</span>
<span class="c">#FLANNEL_OPTIONS=""</span>
</code></pre></div></div>

<ul>
  <li>在节点上启动相关服务（centos-minion-n）</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>SERVICES <span class="k">in </span>kube-proxy kubelet flanneld docker<span class="p">;</span> <span class="k">do
    </span>systemctl restart <span class="nv">$SERVICES</span>
    systemctl <span class="nb">enable</span> <span class="nv">$SERVICES</span>
    systemctl status <span class="nv">$SERVICES</span>
<span class="k">done</span>
</code></pre></div></div>
<ul>
  <li>配置kubectl</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl config set-cluster default-cluster <span class="nt">--server</span><span class="o">=</span>http://centos-master:8080
kubectl config set-context default-context <span class="nt">--cluster</span><span class="o">=</span>default-cluster <span class="nt">--user</span><span class="o">=</span>default-admin
kubectl config use-context default-context
</code></pre></div></div>

<p><em>至此，Kubernetes在CentOS集群中的部署已经完成 ！</em></p>

<ul>
  <li>在centos-master节点上通过kubectl命令检查所有的Kubernetes节点已经到位</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get nodes
NAME                   STATUS     AGE     VERSION
centos-minion-1        Ready      3d      v1.6.0+fff5156
centos-minion-2        Ready      3d      v1.6.0+fff5156   
centos-minion-3        Ready      3d      v1.6.0+fff5156
</code></pre></div></div>

<p><strong>现在，Kubernetes集群已经正常运行！可以创建测试pod验证集群了！</strong></p>

<h2 id="支持级别">支持级别</h2>

<table>
  <thead>
    <tr>
      <th>IaaS Provider</th>
      <th>Config. Mgmt</th>
      <th>OS</th>
      <th>Networking</th>
      <th>Docs</th>
      <th>Conforms</th>
      <th>Support Level</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Bare-metal</td>
      <td>custom</td>
      <td>CentOS</td>
      <td>flannel</td>
      <td><a href="/docs/getting-started-guides/centos/centos_manual_config">docs</a></td>
      <td> </td>
      <td>Community (<a href="https://github.com/coolsvap">@coolsvap</a>)</td>
    </tr>
  </tbody>
</table>

<p>有关所有解决方案的支持级别信息，请参阅<a href="/docs/getting-started-guides/#table-of-solutions">解决方案列表</a>。</p>
