
<p>基于属性的访问控制（Attribute-based access control - ABAC）定义了访问控制范例，其中通过使用将属性组合在一起的策略来向用户授予访问权限。</p>

<ul id="markdown-toc">
  <li><a href="#策略文件格式" id="markdown-toc-策略文件格式">策略文件格式</a></li>
  <li><a href="#授权算法" id="markdown-toc-授权算法">授权算法</a></li>
  <li><a href="#kubectl" id="markdown-toc-kubectl">Kubectl</a></li>
  <li><a href="#例子" id="markdown-toc-例子">例子</a></li>
  <li><a href="#服务帐户的快速说明" id="markdown-toc-服务帐户的快速说明">服务帐户的快速说明</a></li>
</ul>

<h2 id="策略文件格式">策略文件格式</h2>

<p>基于 <code class="highlighter-rouge">ABAC</code> 模式，可以这样指定策略文件 <code class="highlighter-rouge">--authorization-policy-file=SOME_FILENAME</code>。</p>

<p>此文件是 JSON 格式<a href="http://jsonlines.org/">每行都是一个JSON对象</a>，不应存在封闭的列表或映射，每行只有一个映射。</p>

<p>每一行都是一个 “策略对象”，策略对象是具有以下映射的属性:</p>

<ul>
  <li>版本控制属性:
    <ul>
      <li><code class="highlighter-rouge">apiVersion</code>，字符串类型: 有效值为”abac.authorization.kubernetes.io/v1beta1”，允许版本控制和转换策略格式。</li>
      <li><code class="highlighter-rouge">kind</code>，字符串类型: 有效值为 “Policy”，允许版本控制和转换策略格式。</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">spec</code> 配置为具有以下映射的属性:
    <ul>
      <li>匹配属性:
        <ul>
          <li><code class="highlighter-rouge">user</code>，字符串类型; 来自 <code class="highlighter-rouge">--token-auth-file</code> 的用户字符串，如果你指定<code class="highlighter-rouge">user</code>，它必须与验证用户的用户名匹配。</li>
          <li><code class="highlighter-rouge">group</code>，字符串类型; 如果指定<code class="highlighter-rouge">group</code>，它必须与经过身份验证的用户的一个组匹配，<code class="highlighter-rouge">system:authenticated</code>匹配所有经过身份验证的请求。<code class="highlighter-rouge">system:unauthenticated</code>匹配所有未经过身份验证的请求。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>资源匹配属性:
    <ul>
      <li><code class="highlighter-rouge">apiGroup</code>，字符串类型; 一个 API 组。
        <ul>
          <li>例: <code class="highlighter-rouge">extensions</code></li>
          <li>通配符: <code class="highlighter-rouge">*</code>匹配所有 API 组。</li>
        </ul>
      </li>
      <li><code class="highlighter-rouge">namespace</code>，字符串类型; 一个命名空间。
        <ul>
          <li>例如: <code class="highlighter-rouge">kube-system</code></li>
          <li>通配符: <code class="highlighter-rouge">*</code> 匹配所有资源请求。</li>
        </ul>
      </li>
      <li><code class="highlighter-rouge">resource</code>，字符串类型; 资源类型。
        <ul>
          <li>例:<code class="highlighter-rouge">pods</code></li>
          <li>通配符: <code class="highlighter-rouge">*</code>匹配所有资源请求。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>非资源匹配属性:
    <ul>
      <li><code class="highlighter-rouge">nonResourcePath</code>，字符串类型; 非资源请求路径。
        <ul>
          <li>例如:<code class="highlighter-rouge">/version</code>或<code class="highlighter-rouge">/apis</code></li>
          <li>通配符:
            <ul>
              <li><code class="highlighter-rouge">*</code> 匹配所有非资源请求。</li>
              <li><code class="highlighter-rouge">/foo/*</code> 匹配<code class="highlighter-rouge">/foo/</code>的所有子路径。</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">readonly</code>，键入 boolean，如果为 true，则表示该策略仅适用于 get，list 和 watch 操作。</li>
</ul>

<p><strong>注意:</strong> 未设置的属性与类型设置为零值的属性相同(例如空字符串，0、false)，然而未知的应该可读性优先。</p>

<p>在将来，策略可能以 JSON 格式表示，并通过 REST 界面进行管理。</p>

<h2 id="授权算法">授权算法</h2>

<p>请求具有与策略对象的属性对应的属性。</p>

<p>当接收到请求时，确定属性。 未知属性设置为其类型的零值（例如: 空字符串，0，false）。</p>

<p>设置为<code class="highlighter-rouge">“*"</code>的属性将匹配相应属性的任何值。</p>

<p>检查属性的元组，以匹配策略文件中的每个策略。 如果至少有一行匹配请求属性，则请求被授权（但可能会在稍后验证失败）。</p>

<p>要允许任何经过身份验证的用户执行某些操作，请将策略组属性设置为 <code class="highlighter-rouge">"system:authenticated“</code>。</p>

<p>要允许任何未经身份验证的用户执行某些操作，请将策略组属性设置为<code class="highlighter-rouge">"system:authentication“</code>。</p>

<p>要允许用户执行任何操作，请使用 apiGroup，命名空间，
资源和 nonResourcePath 属性设置为 <code class="highlighter-rouge">“*"</code>的策略.</p>

<p>要允许用户执行任何操作，请使用设置为<code class="highlighter-rouge">“*”</code> 的 apiGroup，namespace，resource 和 nonResourcePath 属性编写策略。</p>

<h2 id="kubectl">Kubectl</h2>

<p>Kubectl 使用 api-server 的 <code class="highlighter-rouge">/api</code> 和 <code class="highlighter-rouge">/apis</code> 端点进行协商客户端/服务器版本。 通过创建/更新来验证发送到API的对象操作，kubectl 查询某些 swagger 资源。 对于API版本”v1”, 那就是<code class="highlighter-rouge">/swaggerapi/api/v1</code> ＆ <code class="highlighter-rouge">/swaggerapi/ experimental/v1</code>。</p>

<p>当使用 ABAC 授权时，这些特殊资源必须明确通过策略中的 <code class="highlighter-rouge">nonResourcePath</code> 属性暴露出来(参见下面的<a href="#examples">例子</a>):</p>

<ul>
  <li><code class="highlighter-rouge">/api</code>，<code class="highlighter-rouge">/api/*</code>，<code class="highlighter-rouge">/apis</code>和<code class="highlighter-rouge">/apis/*</code> 用于 API 版本协商.</li>
  <li><code class="highlighter-rouge">/version</code> 通过 <code class="highlighter-rouge">kubectl version</code> 检索服务器版本.</li>
  <li><code class="highlighter-rouge">/swaggerapi/*</code> 用于创建/更新操作.</li>
</ul>

<p>要检查涉及到特定kubectl操作的HTTP调用，您可以调整详细程度：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl --v=8 version
</code></pre></div></div>

<h2 id="例子">例子</h2>

<ol>
  <li>
    <p>Alice 可以对所有资源做任何事情:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"alice"</span><span class="p">,</span><span class="w"> </span><span class="s2">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"> </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"> </span><span class="s2">"apiGroup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">}}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Kubelet 可以读取任何pod:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubelet"</span><span class="p">,</span><span class="w"> </span><span class="s2">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"> </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pods"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Kubelet 可以读写事件:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubelet"</span><span class="p">,</span><span class="w"> </span><span class="s2">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w"> </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"events"</span><span class="p">}}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Bob 可以在命名空间“projectCaribou”中读取 pod:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bob"</span><span class="p">,</span><span class="w"> </span><span class="s2">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"projectCaribou"</span><span class="p">,</span><span class="w"> </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pods"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">}}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>任何人都可以对所有非资源路径进行只读请求:</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:authenticated"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">"nonResourcePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">}}</span><span class="w">
 </span><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Policy"</span><span class="p">,</span><span class="w"> </span><span class="s2">"spec"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"group"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:unauthenticated"</span><span class="p">,</span><span class="w"> </span><span class="s2">"readonly"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s2">"nonResourcePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">}}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ol>

<p><a href="http://releases.k8s.io/master/pkg/auth/authorizer/abac/example_policy_file.jsonl">完整文件示例</a></p>

<h2 id="服务帐户的快速说明">服务帐户的快速说明</h2>

<p>服务帐户自动生成用户。 用户名是根据命名约定生成的:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>system:serviceaccount:&lt;namespace&gt;:&lt;serviceaccountname&gt;
</code></pre></div></div>
<p>创建新的命名空间也会导致创建一个新的服务帐户：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>system:serviceaccount:&lt;namespace&gt;:default
</code></pre></div></div>

<p>例如，如果要将 API 的 kube-system 完整权限中的默认服务帐户授予，则可以将此行添加到策略文件中:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="s2">"abac.authorization.kubernetes.io/v1beta1"</span><span class="p">,</span><span class="s2">"kind"</span><span class="p">:</span><span class="s2">"Policy"</span><span class="p">,</span><span class="s2">"spec"</span><span class="p">:{</span><span class="s2">"user"</span><span class="p">:</span><span class="s2">"system:serviceaccount:kube-system:default"</span><span class="p">,</span><span class="s2">"namespace"</span><span class="p">:</span><span class="s2">"*"</span><span class="p">,</span><span class="s2">"resource"</span><span class="p">:</span><span class="s2">"*"</span><span class="p">,</span><span class="s2">"apiGroup"</span><span class="p">:</span><span class="s2">"*"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>需要重新启动 apitorver 以获取新的策略行.</p>

