<ul id="markdown-toc">
  <li><a href="#节点合规性测试" id="markdown-toc-节点合规性测试">节点合规性测试</a></li>
  <li><a href="#限制" id="markdown-toc-限制">限制</a></li>
  <li><a href="#节点的前提条件" id="markdown-toc-节点的前提条件">节点的前提条件</a></li>
  <li><a href="#运行节点合规性测试" id="markdown-toc-运行节点合规性测试">运行节点合规性测试</a></li>
  <li><a href="#针对其他硬件体系结构运行节点合规性测试" id="markdown-toc-针对其他硬件体系结构运行节点合规性测试">针对其他硬件体系结构运行节点合规性测试</a></li>
  <li><a href="#运行选定的测试" id="markdown-toc-运行选定的测试">运行选定的测试</a></li>
  <li><a href="#注意事项" id="markdown-toc-注意事项">注意事项</a></li>
</ul>

<h2 id="节点合规性测试">节点合规性测试</h2>

<p><em>节点合规性测试</em> 是一个容器化的测试框架，提供了针对节点的系统验证和功能测试。 该测试主要检测节点是否满足 Kubernetes 的最低要求，通过检测的节点有资格加入 Kubernetes 集群。</p>

<h2 id="限制">限制</h2>

<p>在 Kubernetes 1.5版本中，节点合规性测试存在以下限制：</p>

<ul>
  <li>节点合规性测试只支持 Docker 作为容器运行时环境。</li>
</ul>

<h2 id="节点的前提条件">节点的前提条件</h2>

<p>为运行节点合规性测试，节点必须满足与标准的 Kubernetes 节点同样的前提条件。最基本地， 节点应安装以下组件：</p>

<ul>
  <li>容器运行时 (Docker)</li>
  <li>Kubelet</li>
</ul>

<h2 id="运行节点合规性测试">运行节点合规性测试</h2>

<p>执行以下步骤来运行节点合规性测试：</p>

<ol>
  <li>因为测试框架会启动一个本地的 master 来测试 Kubelet，
所以将 Kubelet 指向本机 `–api-servers=”http://localhost:8080”。 还有一些其他 Kubelet 参数可能需要注意：
    <ul>
      <li><code class="highlighter-rouge">--pod-cidr</code>： 如果使用 <code class="highlighter-rouge">kubenet</code>， 需要为 Kubelet 任意指定一个 CIDR， 例如 <code class="highlighter-rouge">--pod-cidr=10.180.0.0/24</code>。</li>
      <li><code class="highlighter-rouge">--cloud-provider</code>： 如果使用 <code class="highlighter-rouge">--cloud-provider=gce</code>，需要移除这个参数来运行测试。</li>
    </ul>
  </li>
  <li>执行以下命令来运行节点合规性测试：</li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># $CONFIG_DIR 是 Kubelet 的 manifest 文件路径。</span>
<span class="c"># $LOG_DIR 是测试结果输出的路径。</span>
<span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--privileged</span> <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
  <span class="nt">-v</span> /:/rootfs <span class="nt">-v</span> <span class="nv">$CONFIG_DIR</span>:<span class="nv">$CONFIG_DIR</span> <span class="nt">-v</span> <span class="nv">$LOG_DIR</span>:/var/result <span class="se">\</span>
  gcr.io/google_containers/node-test:0.2
</code></pre></div></div>

<h2 id="针对其他硬件体系结构运行节点合规性测试">针对其他硬件体系结构运行节点合规性测试</h2>

<p>Kubernetes 也为其他硬件体系结构的系统提供了节点合规性测试的 Docker 镜像：</p>

<table>
  <thead>
    <tr>
      <th>Arch</th>
      <th style="text-align: center">Image</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>amd64</td>
      <td style="text-align: center">node-test-amd64</td>
    </tr>
    <tr>
      <td>arm</td>
      <td style="text-align: center">node-test-arm</td>
    </tr>
    <tr>
      <td>arm64</td>
      <td style="text-align: center">node-test-arm64</td>
    </tr>
  </tbody>
</table>

<h2 id="运行选定的测试">运行选定的测试</h2>

<p>为运行指定的测试，用正则表达式来描述将要运行的测试，并重载 <code class="highlighter-rouge">FOCUS</code> 环境变量。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--privileged</span> <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
  <span class="nt">-v</span> /:/rootfs:ro <span class="nt">-v</span> <span class="nv">$CONFIG_DIR</span>:<span class="nv">$CONFIG_DIR</span> <span class="nt">-v</span> <span class="nv">$LOG_DIR</span>:/var/result <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">FOCUS</span><span class="o">=</span>MirrorPod <span class="se">\ </span><span class="c"># 只运行MirrorPod测试</span>
  gcr.io/google_containers/node-test:0.2
</code></pre></div></div>

<p>为跳过指定的测试，用正则表达式来描述将要跳过的测试，并重载 <code class="highlighter-rouge">SKIP</code> 环境变量。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker run <span class="nt">-it</span> <span class="nt">--rm</span> <span class="nt">--privileged</span> <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
  <span class="nt">-v</span> /:/rootfs:ro <span class="nt">-v</span> <span class="nv">$CONFIG_DIR</span>:<span class="nv">$CONFIG_DIR</span> <span class="nt">-v</span> <span class="nv">$LOG_DIR</span>:/var/result <span class="se">\</span>
  <span class="nt">-e</span> <span class="nv">SKIP</span><span class="o">=</span>MirrorPod <span class="se">\ </span><span class="c"># 运行除MirrorPod外的所有测试</span>
  gcr.io/google_containers/node-test:0.2
</code></pre></div></div>

<p>节点合规性测试是<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/e2e-node-tests.md">节点端到端测试</a>的一个容器化的版本。
默认情况下， 它会运行所有的合规性测试用例。</p>

<p>理论上，只要合理地配置容器和挂载所需的卷，就可以运行任何的节点端到端测试用例。 但是这里 <strong>强烈建议只运行合规性测试</strong>，因为运行非合规性测试需要很多复杂的配置。</p>

<h2 id="注意事项">注意事项</h2>

<ul>
  <li>测试会在节点上遗留一些Docker镜像， 包括节点合规性测试本身的镜像，和功能测试相关的镜像。</li>
  <li>测试会在节点上遗留一些死的容器。这些容器是在功能测试的过程中创建的。</li>
</ul>
