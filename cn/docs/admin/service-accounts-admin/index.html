<p><em>这是一篇针对service accounts（服务账户）的集群管理员指南。  它呈现了 <a href="/docs/user-guide/service-accounts">User Guide to Service Accounts</a>中的信息。</em></p>

<p><em>对授权和用户账户的支持已在规划中，当前并不完备，为了更好地描述service accounts，有时这些不完善的特性也会被提及。</em></p>

<h2 id="用户账户与服务账户">用户账户与服务账户</h2>

<p>Kubernetes 区分用户账户和服务账户的概念主要基于以下原因：</p>

<ul>
  <li>用户账户是针对人而言的。  服务账户是针对运行在pod中的进程而言的。</li>
  <li>用户账户是全局性的。 其名称在集群各namespace中都是全局唯一的，未来的用户资源不会做namespace隔离，
服务账户是namespace隔离的。</li>
  <li>通常情况下，集群的用户账户可能会从企业数据库进行同步，其创建需要特殊权限，并且涉及到复杂的业务流程。 服务账户创建的目的是为了更轻量，允许集群用户为了具体的任务创建服务账户 (即权限最小化原则)。</li>
  <li>对人员和服务账户审计所考虑的因素可能不同。</li>
  <li>针对复杂系统的配置可能包含系统组件相关的各种服务账户的定义。 因为服务账户可以定制化地创建，并且有namespace级别的名称，这种配置是很轻量的。</li>
</ul>

<h2 id="服务账户的自动化">服务账户的自动化</h2>

<p>三个独立组件协作完成服务账户相关的自动化:</p>

<ul>
  <li>服务账户准入控制器（Service account admission controller）</li>
  <li>Token控制器（Token controller）</li>
  <li>服务账户控制器（Service account controller）</li>
</ul>

<h3 id="服务账户准入控制器">服务账户准入控制器</h3>

<p>对pod的改动通过一个被称为<a href="/docs/admin/admission-controllers">Admission Controller</a>的插件来实现。它是apiserver的一部分。
当pod被创建或更新时，它会同步地修改pod。 当该插件处于激活状态(在大多数发行版中都是默认的)，当pod被创建或更新时它会进行以下动作：</p>

<ol>
  <li>如果该pod没有 <code class="highlighter-rouge">ServiceAccount</code> 设置，将其 <code class="highlighter-rouge">ServiceAccount</code> 设为 <code class="highlighter-rouge">default</code>。</li>
  <li>保证pod所关联的 <code class="highlighter-rouge">ServiceAccount</code> 存在，否则拒绝该pod。</li>
  <li>如果pod不包含 <code class="highlighter-rouge">ImagePullSecrets</code>设置，那么 将 <code class="highlighter-rouge">ServiceAccount</code>中的<code class="highlighter-rouge">ImagePullSecrets</code> 信息添加到pod中。</li>
  <li>将一个包含用于API访问的token的 <code class="highlighter-rouge">volume</code> 添加到pod中。</li>
  <li>将挂载于 <code class="highlighter-rouge">/var/run/secrets/kubernetes.io/serviceaccount</code> 的 <code class="highlighter-rouge">volumeSource</code>添加到pod下的每个容器中。</li>
</ol>

<h3 id="token管理器">Token管理器</h3>

<p>Token管理器是controller-manager的一部分。 以异步的形式工作：</p>

<ul>
  <li>检测服务账户的创建，并且创建相应的Secret以支持API访问。</li>
  <li>检测服务账户的删除，并且删除所有相应的服务账户Token Secret。</li>
  <li>检测Secret的增加，保证相应的服务账户存在，如有需要，为Secret增加token。</li>
  <li>检测Secret的删除，如有需要，从相应的服务账户中移除引用。</li>
</ul>

<p>你需要通过 <code class="highlighter-rouge">--service-account-private-key-file</code> 参数项传入一个服务账户私钥文件至Token管理器。 私钥用于为生成的服务账户token签名。
同样地，你需要通过 <code class="highlighter-rouge">--service-account-key-file</code> 参数将对应的公钥传入kube-apiserver。 公钥用于认证过程中的token校验。</p>

<h4 id="创建额外的-api-tokens">创建额外的 API tokens</h4>

<p>控制器中有专门的循环来保证每个服务账户中都存在API token对应的Secret。 当需要为服务账户创建额外的API token时，创建一个类型为 <code class="highlighter-rouge">ServiceAccountToken</code> 的Secret，并在annotation中引用服务账户，控制器会生成token并更新:</p>

<p>secret.json:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"kind"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Secret"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"apiVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"v1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mysecretname"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"annotations"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"kubernetes.io/service-account.name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"myserviceaccount"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes.io/service-account-token"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> ./secret.json
kubectl describe secret mysecretname
</code></pre></div></div>

<h4 id="删除失效-服务账户token">删除/失效 服务账户token</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete secret mysecretname
</code></pre></div></div>

<h3 id="服务账户管理器">服务账户管理器</h3>

<p>服务账户管理器管理各命名空间下的服务账户，并且保证每个活跃的命名空间下存在一个名为 “default” 的服务账户</p>
