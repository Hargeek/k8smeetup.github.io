<ul id="markdown-toc">
  <li><a href="#前提" id="markdown-toc-前提">前提</a></li>
  <li><a href="#隔离和非隔离的pod" id="markdown-toc-隔离和非隔离的pod">隔离和非隔离的Pod</a></li>
  <li><a href="#networkpolicy-资源" id="markdown-toc-networkpolicy-资源"><code class="highlighter-rouge">NetworkPolicy</code> 资源</a></li>
  <li><a href="#默认策略" id="markdown-toc-默认策略">默认策略</a></li>
  <li><a href="#下一步呢" id="markdown-toc-下一步呢">下一步呢？</a></li>
</ul>

<p>网络策略（NetworkPolicy）是一种关于pod间及pod与其他网络端点间所允许的通信规则的规范。</p>

<p><code class="highlighter-rouge">NetworkPolicy</code> 资源使用标签选择pod，并定义选定pod所允许的通信规则。</p>

<h2 id="前提">前提</h2>

<p>网络策略通过网络插件来实现，所以用户必须使用支持 <code class="highlighter-rouge">NetworkPolicy</code> 的网络解决方案 - 简单地创建资源对象，而没有控制器来使它生效的话，是没有任何作用的。</p>

<h2 id="隔离和非隔离的pod">隔离和非隔离的Pod</h2>

<p>默认情况下，Pod是非隔离的，它们接受任何来源的流量。</p>

<p>Pod可以通过相关的网络策略进行隔离。一旦命名空间中有网络策略选择了特定的Pod，该Pod会拒绝网络策略所不允许的连接。 (命名空间下其他未被网络策略所选择的Pod会继续接收所有的流量)</p>

<h2 id="networkpolicy-资源"><code class="highlighter-rouge">NetworkPolicy</code> 资源</h2>

<p>通过<a href="/docs/api-reference/v1.8/#networkpolicy-v1-networking">api参考</a>来了解资源定义。</p>

<p>下面是一个 <code class="highlighter-rouge">NetworkPolicy</code> 的示例:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test-network-policy</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">role</span><span class="pi">:</span> <span class="s">db</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">namespaceSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">project</span><span class="pi">:</span> <span class="s">myproject</span>
    <span class="pi">-</span> <span class="na">podSelector</span><span class="pi">:</span>
        <span class="na">matchLabels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">frontend</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">6379</span>
</code></pre></div></div>

<p>除非选择支持网络策略的网络解决方案，否则将上述示例发送到API服务器没有任何效果。</p>

<p><strong>必填字段</strong>: 与所有其他的Kubernetes配置一样，<code class="highlighter-rouge">NetworkPolicy</code> 需要 <code class="highlighter-rouge">apiVersion</code>、 <code class="highlighter-rouge">kind</code>和 <code class="highlighter-rouge">metadata</code> 字段。 关于配置文件操作的一般信息，请参考 <a href="/docs/user-guide/simple-yaml">这里</a>、 <a href="/docs/user-guide/configuring-containers">这里</a>和 <a href="/docs/user-guide/working-with-resources">这里</a>。</p>

<p><strong>spec</strong>: <code class="highlighter-rouge">NetworkPolicy</code> <a href="https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status">spec</a> 中包含了在一个命名空间中定义特定网络策略所需的所有信息</p>

<p><strong>podSelector</strong>: 每个 <code class="highlighter-rouge">NetworkPolicy</code> 都包括一个 <code class="highlighter-rouge">podSelector</code> ，它对该策略所应用的一组Pod进行选择。因为 <code class="highlighter-rouge">NetworkPolicy</code> 目前只支持定义 <code class="highlighter-rouge">ingress</code> 规则，这里的 <code class="highlighter-rouge">podSelector</code> 本质上是为该策略定义 “目标pod” 。示例中的策略选择带有 “role=db” 标签的pod。空的 <code class="highlighter-rouge">podSelector</code> 选择命名空间下的所有pod。</p>

<p><strong>ingress</strong>: 每个 <code class="highlighter-rouge">NetworkPolicy</code> 包含一个 <code class="highlighter-rouge">ingress</code> 规则的白名单列表。 （其中的）规则允许同时匹配 <code class="highlighter-rouge">from</code> 和 <code class="highlighter-rouge">ports</code> 部分的流量。示例策略中包含一条简单的规则： 它匹配一个单一的端口，来自两个来源中的一个， 第一个通过 <code class="highlighter-rouge">namespaceSelector</code> 指定，第二个通过 <code class="highlighter-rouge">podSelector</code> 指定。</p>

<p>所以，示例网络策略:</p>

<ol>
  <li>隔离 “default” 命名空间下 “role=db” 的pod (如果它们不是已经被隔离的话)。</li>
  <li>允许从 “default” 命名空间下带有 “role=frontend” 标签的pod到 “default” 命名空间下的pod的6379 TCP端口的连接。</li>
  <li>允许从带有 “project=myproject” 标签的命名空间下的任何pod到 “default” 命名空间下的pod的6379 TCP端口的连接。</li>
</ol>

<p>查看 <a href="/docs/getting-started-guides/network-policy/walkthrough">网络策略入门指南</a> 了解更多示例。</p>

<h2 id="默认策略">默认策略</h2>

<p>用户可以通过创建一个选择所有Pod，但是不允许任何通信的网络策略，来为一个命名空间创建 “默认的” 隔离策略：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default-deny</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
</code></pre></div></div>

<p>这可以确保即使Pod在未被其他任何网络策略所选择的情况下仍能被隔离。</p>

<p>或者，如果用户希望允许一个命名空间下的所有Pod的所有通信 (即使已经添加了策略，使得一些pod被 “隔离”)，仍可以创建一个明确允许所有通信的策略：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">NetworkPolicy</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">allow-all</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">podSelector</span><span class="pi">:</span>
  <span class="na">ingress</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{}</span>
</code></pre></div></div>

<h2 id="下一步呢">下一步呢？</h2>

<ul>
  <li>查看 <a href="/docs/tasks/administer-cluster/declare-network-policy/">声明网络策略</a>
来进行更多的示例演练</li>
</ul>
