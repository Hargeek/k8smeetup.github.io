<ul id="markdown-toc">
  <li><a href="#默认-hosts-文件内容" id="markdown-toc-默认-hosts-文件内容">默认 hosts 文件内容</a></li>
  <li><a href="#通过-hostaliases-增加额外的条目" id="markdown-toc-通过-hostaliases-增加额外的条目">通过 HostAliases 增加额外的条目</a></li>
  <li><a href="#限制" id="markdown-toc-限制">限制</a></li>
  <li><a href="#为什么-kubelet-管理-hosts文件" id="markdown-toc-为什么-kubelet-管理-hosts文件">为什么 Kubelet 管理 hosts文件？</a></li>
</ul>

<p>当 DNS 配置以及其它选项不合理的时候，通过向 Pod 的 /etc/hosts 文件中添加条目，可以在 Pod 级别覆盖对主机名的解析。在 1.7 版本，用户可以通过 PodSpec 的 HostAliases 字段来添加这些自定义的条目。</p>

<p>建议通过使用 HostAliases 来进行修改，因为该文件由 Kubelet 管理，并且可以在 Pod 创建/重启过程中被重写。</p>

<h2 id="默认-hosts-文件内容">默认 hosts 文件内容</h2>

<p>让我们从一个 Nginx Pod 开始，给该 Pod 分配一个 IP：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get pods --output=wide
NAME     READY     STATUS    RESTARTS   AGE    IP           NODE
nginx    1/1       Running   0          13s    10.200.0.4   worker0
</code></pre></div></div>

<p>默认，hosts 文件只包含 ipv4 和 ipv6 的样板内容，像 <code class="highlighter-rouge">localhost</code> 和主机名称。</p>

<h2 id="通过-hostaliases-增加额外的条目">通过 HostAliases 增加额外的条目</h2>

<p>除了默认的样板内容，我们可以向 hosts 文件添加额外的条目，将 <code class="highlighter-rouge">foo.local</code>、 <code class="highlighter-rouge">bar.local</code> 解析为<code class="highlighter-rouge">127.0.0.1</code>，将 <code class="highlighter-rouge">foo.remote</code>、 <code class="highlighter-rouge">bar.remote</code> 解析为 <code class="highlighter-rouge">10.1.2.3</code>，我们可以在 <code class="highlighter-rouge">.spec.hostAliases</code> 下为 Pod 添加 HostAliases。</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/docs/concepts/services-networking/hostaliases-pod.yaml" download="hostaliases-pod.yaml">
                    <code>hostaliases-pod.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('hostaliases-pod.yaml')" title="Copy hostaliases-pod.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="hostaliases-pod.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hostaliases-pod</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hostAliases</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s2">"</span><span class="s">127.0.0.1"</span>
    <span class="na">hostnames</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">foo.local"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">bar.local"</span>
  <span class="pi">-</span> <span class="na">ip</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.1.2.3"</span>
    <span class="na">hostnames</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">foo.remote"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">bar.remote"</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cat-hosts</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">busybox</span>
    <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cat</span>
    <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">/etc/hosts"</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>hosts 文件的内容看起来类似如下这样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl logs hostaliases-pod
# Kubernetes-managed hosts file.
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
fe00::0	ip6-mcastprefix
fe00::1	ip6-allnodes
fe00::2	ip6-allrouters
10.200.0.4	hostaliases-pod
127.0.0.1	foo.local
127.0.0.1	bar.local
10.1.2.3	foo.remote
10.1.2.3	bar.remote
</code></pre></div></div>

<p>在最下面额外添加了一些条目。</p>

<h2 id="限制">限制</h2>

<p>在 1.7 版本，如果 Pod 启用 hostNetwork，那么将不能使用这个特性，因为 kubelet 只管理非 hostNetwork 类型 Pod 的 hosts 文件。目前正在讨论要改变这个情况。</p>

<h2 id="为什么-kubelet-管理-hosts文件">为什么 Kubelet 管理 hosts文件？</h2>

<p>kubelet <a href="https://github.com/kubernetes/kubernetes/issues/14633">管理</a> Pod 中每个容器的 hosts 文件，避免 Docker 在容器已经启动之后去 <a href="https://github.com/moby/moby/issues/17190">修改</a> 该文件。</p>

<p>因为该文件是托管性质的文件，无论容器重启或 Pod 重新调度，用户修改该 hosts 文件的任何内容，都会在 Kubelet 重新安装后被覆盖。因此，不建议修改该文件的内容。</p>
