
<p>本示例展示了在一个 namespace 中控制资源用量的典型设置。</p>

<p>本文展示了以下资源的使用： <a href="/docs/admin/namespaces">Namespace</a>, <a href="/docs/concepts/policy/resource-quotas/">ResourceQuota</a> 和  <a href="/docs/tasks/configure-pod-container/limit-range/">LimitRange</a>。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#场景" id="markdown-toc-场景">场景</a></li>
  <li><a href="#创建-namespace" id="markdown-toc-创建-namespace">创建 namespace</a></li>
  <li><a href="#应用-object-count-配额到-namespace" id="markdown-toc-应用-object-count-配额到-namespace">应用 object-count 配额到 namespace</a></li>
  <li><a href="#应用计算资源配额到-namespace" id="markdown-toc-应用计算资源配额到-namespace">应用计算资源配额到 namespace</a></li>
  <li><a href="#应用默认资源请求和限制" id="markdown-toc-应用默认资源请求和限制">应用默认资源请求和限制</a></li>
  <li><a href="#高级配额-scopes" id="markdown-toc-高级配额-scopes">高级配额 scopes</a></li>
  <li><a href="#总结" id="markdown-toc-总结">总结</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>
    <p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>
  </li>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="场景">场景</h2>

<p>集群管理员正在操作一个代表用户群体的集群，他希望控制一个特定 namespace 中可以被使用的资源总量，以达到促进对集群的公平共享及控制成本的目的。</p>

<p>集群管理员有以下目标：</p>

<ul>
  <li>限制运行中 pods 使用的计算资源数量</li>
  <li>限制 persistent volume claims 数量以控制对存储的访问</li>
  <li>限制 load balancers 数量以控制成本</li>
  <li>防止使用 node ports 以保留稀缺资源</li>
  <li>提供默认计算资源请求以实现更好的调度决策</li>
</ul>

<h2 id="创建-namespace">创建 namespace</h2>

<p>本示例将在一个自定义的 namespace 中运行，以展示相关概念。</p>

<p>让我们创建一个叫做 quota-example 的新 namespace：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create namespace quota-example
namespace <span class="s2">"quota-example"</span> created
<span class="nv">$ </span>kubectl get namespaces
NAME            STATUS    AGE
default         Active    2m
kube-system     Active    2m
quota-example   Active    39s
</code></pre></div></div>

<h2 id="应用-object-count-配额到-namespace">应用 object-count 配额到 namespace</h2>

<p>集群管理员想要控制下列资源：</p>

<ul>
  <li>persistent volume claims</li>
  <li>load balancers</li>
  <li>node ports</li>
</ul>

<p>我们来创建一个简单的配额，用于控制这个 namespace 中那些资源类型的对象数量。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/rq-object-counts.yaml <span class="nt">--namespace</span><span class="o">=</span>quota-example
resourcequota <span class="s2">"object-counts"</span> created
</code></pre></div></div>

<p>配额系统将察觉到有一个配额被创建，并且会计算 namespace 中的资源消耗量作为响应。这应该会很快发生。</p>

<p>让我们显示一下配额来观察这个 namespace 中当前被消耗的资源：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe quota object-counts <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:                  object-counts
Namespace:             quota-example
Resource               Used    Hard
<span class="nt">--------</span>               <span class="nt">----</span>    <span class="nt">----</span>
persistentvolumeclaims 0    2
services.loadbalancers 0    2
services.nodeports     0    0
</code></pre></div></div>

<p>配额系统现在将阻止用户创建比各个资源指定数量更多的资源。</p>

<h2 id="应用计算资源配额到-namespace">应用计算资源配额到 namespace</h2>

<p>为了限制这个 namespace 可以被使用的计算资源数量，让我们创建一个跟踪计算资源的配额。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/rq-compute-resources.yaml <span class="nt">--namespace</span><span class="o">=</span>quota-example
resourcequota <span class="s2">"compute-resources"</span> created
</code></pre></div></div>

<p>让我们显示一下配额来观察这个 namespace 中当前被消耗的资源：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe quota compute-resources <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:                  compute-resources
Namespace:             quota-example
Resource               Used Hard
<span class="nt">--------</span>               <span class="nt">----</span> <span class="nt">----</span>
limits.cpu             0    2
limits.memory          0    2Gi
pods                   0    4
requests.cpu           0    1
requests.memory        0    1Gi
</code></pre></div></div>

<p>配额系统现在会防止 namespace 拥有超过 4 个没有终止的 pods。此外它还将强制 pod 中的每个容器配置一个 <code class="highlighter-rouge">request</code> 并为 <code class="highlighter-rouge">cpu</code> 和 <code class="highlighter-rouge">memory</code> 定义 <code class="highlighter-rouge">limit</code>。</p>

<h2 id="应用默认资源请求和限制">应用默认资源请求和限制</h2>

<p>Pod 的作者很少为它们的 pods 指定资源请求和限制。</p>

<p>既然我们对项目应用了配额，我们来看一下当终端用户通过创建一个没有 cpu 和 内存限制的 pod 时会发生什么。这通过在 pod 里创建一个 nginx 容器实现。</p>

<p>作为演示，让我们来创建一个运行 nginx 的 deployment：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl run nginx <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--replicas</span><span class="o">=</span>1 <span class="nt">--namespace</span><span class="o">=</span>quota-example
deployment <span class="s2">"nginx"</span> created
</code></pre></div></div>

<p>现在我们来看一下创建的 pods。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">--namespace</span><span class="o">=</span>quota-example
</code></pre></div></div>

<p>发生了什么？我一个 pods 都没有！让我们 describe 这个 deployment 来看看发生了什么。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe deployment nginx <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:                   nginx
Namespace:              quota-example
CreationTimestamp:      Mon, 06 Jun 2016 16:11:37 <span class="nt">-0400</span>
Labels:                 <span class="nv">run</span><span class="o">=</span>nginx
Selector:               <span class="nv">run</span><span class="o">=</span>nginx
Replicas:               0 updated | 1 total | 0 available | 1 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  1 max unavailable, 1 max surge
OldReplicaSets:         &lt;none&gt;
NewReplicaSet:          nginx-3137573019 <span class="o">(</span>0/1 replicas created<span class="o">)</span>
...
</code></pre></div></div>

<p>Deployment 创建了一个对应的 replica set 并尝试按照大小来创建一个 pod。</p>

<p>让我们看看 replica set 的更多细节。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe rs nginx-3137573019 <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:                   nginx-3137573019
Namespace:              quota-example
Image<span class="o">(</span>s<span class="o">)</span>:               nginx
Selector:               pod-template-hash<span class="o">=</span>3137573019,run<span class="o">=</span>nginx
Labels:                 pod-template-hash<span class="o">=</span>3137573019
                        <span class="nv">run</span><span class="o">=</span>nginx
Replicas:               0 current / 1 desired
Pods Status:            0 Running / 0 Waiting / 0 Succeeded / 0 Failed
No volumes.
Events:
  FirstSeen    LastSeen    Count From                    SubobjectPath Type      Reason        Message
  <span class="nt">---------</span>    <span class="nt">--------</span>  <span class="nt">-----</span> <span class="nt">----</span>                    <span class="nt">-------------</span>    <span class="nt">--------</span>  <span class="nt">------</span>        <span class="nt">-------</span>
  4m        7s        11    <span class="o">{</span>replicaset-controller <span class="o">}</span>              Warning   FailedCreate  Error creating: pods <span class="s2">"nginx-3137573019-"</span> is forbidden: Failed quota: compute-resources: must specify limits.cpu,limits.memory,requests.cpu,requests.memory
</code></pre></div></div>

<p>Kubernetes API server 拒绝了  replica set 创建一个 pod 的请求，因为我们的 pods 没有为 <code class="highlighter-rouge">cpu</code> 和 <code class="highlighter-rouge">memory</code> 指定 <code class="highlighter-rouge">requests</code> 或 <code class="highlighter-rouge">limits</code>。</p>

<p>因此，我们来为 pod 指定它可以使用的 <code class="highlighter-rouge">cpu</code> 和 <code class="highlighter-rouge">memory</code> 默认数量。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/rq-limits.yaml <span class="nt">--namespace</span><span class="o">=</span>quota-example
limitrange <span class="s2">"limits"</span> created
<span class="nv">$ </span>kubectl describe limits limits <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:           limits
Namespace:      quota-example
Type      Resource  Min  Max  Default Request   Default Limit   Max Limit/Request Ratio
<span class="nt">----</span>      <span class="nt">--------</span>  <span class="nt">---</span>  <span class="nt">---</span>  <span class="nt">---------------</span>   <span class="nt">-------------</span>   <span class="nt">-----------------------</span>
Container memory    -    -    256Mi             512Mi           -
Container cpu       -    -    100m              200m            -
</code></pre></div></div>

<p>如果 Kubernetes API server 发现一个 namespace 中有一个创建 pod 的请求，并且 pod 中的容器没有设置任何计算资源请求时，作为准入控制的一部分，一个默认的 request 和 limit 将会被应用。</p>

<p>在本例中，创建的每个 pod 都将拥有如下的计算资源限制：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl run nginx <span class="se">\</span>
  <span class="nt">--image</span><span class="o">=</span>nginx <span class="se">\</span>
  <span class="nt">--replicas</span><span class="o">=</span>1 <span class="se">\</span>
  <span class="nt">--requests</span><span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>100m,memory<span class="o">=</span>256Mi <span class="se">\</span>
  <span class="nt">--limits</span><span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>200m,memory<span class="o">=</span>512Mi <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>quota-example
</code></pre></div></div>

<p>由于已经为我们的 namespace 申请了默认的计算资源，我们的 replica set 应该能够创建它的 pods 了。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">--namespace</span><span class="o">=</span>quota-example
NAME                     READY     STATUS    RESTARTS   AGE
nginx-3137573019-fvrig   1/1       Running   0          6m
</code></pre></div></div>

<p>而且如果打印出我们在这个 namespace 中的配额使用情况：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe quota <span class="nt">--namespace</span><span class="o">=</span>quota-example
Name:           compute-resources
Namespace:      quota-example
Resource        Used    Hard
<span class="nt">--------</span>        <span class="nt">----</span>    <span class="nt">----</span>
limits.cpu      200m    2
limits.memory   512Mi   2Gi
pods            1       4
requests.cpu    100m    1
requests.memory 256Mi   1Gi


Name:                 object-counts
Namespace:            quota-example
Resource              Used    Hard
<span class="nt">--------</span>              <span class="nt">----</span>    <span class="nt">----</span>
persistentvolumeclaims 0      2
services.loadbalancers 0      2
services.nodeports     0      0
</code></pre></div></div>

<p>就像你看到的，创建的 pod 消耗了明确的计算资源量，并且正被 Kubernetes 正确的追踪着。</p>

<h2 id="高级配额-scopes">高级配额 scopes</h2>

<p>让我们想象一下如果你不希望为你的 namespace 指定默认计算资源使用量。</p>

<p>作为替换，你希望用户在它们的 namespace 中运行指定数量的 <code class="highlighter-rouge">BestEffort</code> pods，以从宽松的计算资源中获得好处。然后要求用户为需要更高质量服务的 pods 配置一个显式的资源请求。</p>

<p>让我们新建一个拥有两个配额的 namespace 来演示这种行为：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl create namespace quota-scopes
namespace <span class="s2">"quota-scopes"</span> created
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/rq-best-effort.yaml <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
resourcequota <span class="s2">"best-effort"</span> created
<span class="nv">$ </span>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/rq-not-best-effort.yaml <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
resourcequota <span class="s2">"not-best-effort"</span> created
<span class="nv">$ </span>kubectl describe quota <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
Name:       best-effort
Namespace:  quota-scopes
Scopes:     BestEffort
 <span class="k">*</span> Matches all pods that have best effort quality of service.
Resource    Used    Hard
<span class="nt">--------</span>    <span class="nt">----</span>  <span class="nt">----</span>
pods        0     10


Name:             not-best-effort
Namespace:        quota-scopes
Scopes:           NotBestEffort
 <span class="k">*</span> Matches all pods that <span class="k">do </span>not have best effort quality of service.
Resource          Used  Hard
<span class="nt">--------</span>          <span class="nt">----</span>  <span class="nt">----</span>
limits.cpu        0     2
limits.memory     0     2Gi
pods              0     4
requests.cpu      0     1
requests.memory   0     1Gi
</code></pre></div></div>

<p>在这种场景下，一个没有配置计算资源请求的 pod 将会被 <code class="highlighter-rouge">best-effort</code> 配额跟踪。</p>

<p>而配置了计算资源请求的则会被 <code class="highlighter-rouge">not-best-effort</code> 配额追踪。</p>

<p>让我们创建两个 deployments 作为演示：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl run best-effort-nginx <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--replicas</span><span class="o">=</span>8 <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
deployment <span class="s2">"best-effort-nginx"</span> created
<span class="nv">$ </span>kubectl run not-best-effort-nginx <span class="se">\</span>
  <span class="nt">--image</span><span class="o">=</span>nginx <span class="se">\</span>
  <span class="nt">--replicas</span><span class="o">=</span>2 <span class="se">\</span>
  <span class="nt">--requests</span><span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>100m,memory<span class="o">=</span>256Mi <span class="se">\</span>
  <span class="nt">--limits</span><span class="o">=</span><span class="nv">cpu</span><span class="o">=</span>200m,memory<span class="o">=</span>512Mi <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
deployment <span class="s2">"not-best-effort-nginx"</span> created
</code></pre></div></div>

<p>虽然没有指定默认的 limits，<code class="highlighter-rouge">best-effort-nginx</code> deployment 还是会创建 8 个 pods。这是由于它被 <code class="highlighter-rouge">best-effort</code> 配额追踪，而 <code class="highlighter-rouge">not-best-effort</code> 配额将忽略它。<code class="highlighter-rouge">not-best-effort</code> 配额将追踪 <code class="highlighter-rouge">not-best-effort-nginx</code> deployment，因为它创建的 pods 具有 <code class="highlighter-rouge">Burstable</code> 服务质量。</p>

<p>让我们列出 namespace 中的 pods：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
NAME                                     READY     STATUS    RESTARTS   AGE
best-effort-nginx-3488455095-2qb41       1/1       Running   0          51s
best-effort-nginx-3488455095-3go7n       1/1       Running   0          51s
best-effort-nginx-3488455095-9o2xg       1/1       Running   0          51s
best-effort-nginx-3488455095-eyg40       1/1       Running   0          51s
best-effort-nginx-3488455095-gcs3v       1/1       Running   0          51s
best-effort-nginx-3488455095-rq8p1       1/1       Running   0          51s
best-effort-nginx-3488455095-udhhd       1/1       Running   0          51s
best-effort-nginx-3488455095-zmk12       1/1       Running   0          51s
not-best-effort-nginx-2204666826-7sl61   1/1       Running   0          23s
not-best-effort-nginx-2204666826-ke746   1/1       Running   0          23s
</code></pre></div></div>

<p>如你看到的，所有 10 个 pods 都已经被准许创建。</p>

<p>让我们 describe 这个 namespace 当前的配额使用情况：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl describe quota <span class="nt">--namespace</span><span class="o">=</span>quota-scopes
Name:            best-effort
Namespace:       quota-scopes
Scopes:          BestEffort
 <span class="k">*</span> Matches all pods that have best effort quality of service.
Resource         Used  Hard
<span class="nt">--------</span>         <span class="nt">----</span>  <span class="nt">----</span>
pods             8     10


Name:               not-best-effort
Namespace:          quota-scopes
Scopes:             NotBestEffort
 <span class="k">*</span> Matches all pods that <span class="k">do </span>not have best effort quality of service.
Resource            Used  Hard
<span class="nt">--------</span>            <span class="nt">----</span>  <span class="nt">----</span>
limits.cpu          400m  2
limits.memory       1Gi   2Gi
pods                2     4
requests.cpu        200m  1
requests.memory     512Mi 1Gi
</code></pre></div></div>

<p>如你看到的，<code class="highlighter-rouge">best-effort</code> 配额追踪了我们在 <code class="highlighter-rouge">best-effort-nginx</code> deployment 中创建的 8 个 pods 的资源用量，而 <code class="highlighter-rouge">not-best-effort</code> 配额追踪了我们在 <code class="highlighter-rouge">not-best-effort-nginx</code> deployment 中创的两个 pods 的用量。</p>

<p>Scopes 提供了一种来对任何配额文档追踪的资源集合进行细分的机制，给操作人员部署和追踪资源消耗带来更大的灵活性。</p>

<p>除 <code class="highlighter-rouge">BestEffort</code> 和 <code class="highlighter-rouge">NotBestEffort</code> scopes 之外，还有用于限制长时间运行和有时限 pods 的scopes。<code class="highlighter-rouge">Terminating</code> scope 将匹配任何 <code class="highlighter-rouge">spec.activeDeadlineSeconds</code> 不为 <code class="highlighter-rouge">nil</code> 的 pod。<code class="highlighter-rouge">NotTerminating</code> scope 将匹配任何 <code class="highlighter-rouge">spec.activeDeadlineSeconds</code> 为 <code class="highlighter-rouge">nil</code> 的 pod。这些 scopes 允许你基于 pods 在你集群中 node 上的预期持久程度来为它们指定配额。</p>

<h2 id="总结">总结</h2>

<p>消耗节点 cpu 和 memory 资源的动作受到 namespace 配额定义的硬性配额限制的管制。</p>

<p>任意消耗那些资源的动作能够被调整，或者获得一个 namespace 级别的默认值以符合你最终的目标。</p>

<p>可以基于服务质量或者在你集群中节点上的预期持久程度来分配配额。</p>

