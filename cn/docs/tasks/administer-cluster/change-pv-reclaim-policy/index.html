
<p>本文展示了如何更改 Kubernetes PersistentVolume 的回收策略。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#为什么要更改-persistentvolume-的回收策略" id="markdown-toc-为什么要更改-persistentvolume-的回收策略">为什么要更改 PersistentVolume 的回收策略</a></li>
  <li><a href="#更改-persistentvolume-的回收策略" id="markdown-toc-更改-persistentvolume-的回收策略">更改 PersistentVolume 的回收策略</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a>    <ul>
      <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
    </ul>
  </li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>

<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="为什么要更改-persistentvolume-的回收策略">为什么要更改 PersistentVolume 的回收策略</h2>

<p><code class="highlighter-rouge">PersistentVolumes</code> 可以有多种回收策略，包括 “Retain”、”Recycle” 和  “Delete”。对于动态配置的 <code class="highlighter-rouge">PersistentVolumes</code> 来说，默认回收策略为 “Delete”。这表示当用户删除对应的 <code class="highlighter-rouge">PersistentVolumeClaim</code> 时，动态配置的 volume 将被自动删除。如果 volume 包含重要数据时，这种自动行为可能是不合适的。那种情况下，更适合使用 “Retain” 策略。使用 “Retain” 时，如果用户删除 <code class="highlighter-rouge">PersistentVolumeClaim</code>，对应的 <code class="highlighter-rouge">PersistentVolume</code> 不会被删除。相反，它将变为 <code class="highlighter-rouge">Released</code> 状态，表示所有的数据可以被手动恢复。</p>

<h2 id="更改-persistentvolume-的回收策略">更改 PersistentVolume 的回收策略</h2>

<ol>
  <li>
    <p>列出你集群中的 PersistentVolumes</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pv
</code></pre></div>    </div>

    <p>输出类似于这样：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NAME                                       CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM                  REASON    AGE
 pvc-b6efd8da-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim1                   10s
 pvc-b95650f8-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim2                   6s
 pvc-bb3ca71d-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim3                   3s
</code></pre></div>    </div>

    <p>这个列表同样包含了绑定到每个 volume 的 claims 名称，以便更容易的识别动态配置的 volumes。</p>
  </li>
  <li>
    <p>选择你的 PersistentVolumes 中的一个并更改它的回收策略：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl patch pv &lt;your-pv-name&gt; -p '{"spec":{"persistentVolumeReclaimPolicy":"Retain"}}'
</code></pre></div>    </div>

    <p>这里的 <code class="highlighter-rouge">&lt;your-pv-name&gt;</code> 是你选择的 PersistentVolume 的名字。</p>
  </li>
  <li>
    <p>验证你选择的 PersistentVolume 拥有正确的策略：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pv
</code></pre></div>    </div>

    <p>输出类似于这样：</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NAME                                       CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM                  REASON    AGE
 pvc-b6efd8da-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim1                   40s
 pvc-b95650f8-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Delete          Bound     default/claim2                   36s
 pvc-bb3ca71d-b7b5-11e6-9d58-0ed433a7dd94   4Gi        RWO           Retain          Bound     default/claim3                   33s
</code></pre></div>    </div>

    <p>在前面的输出中，你可以看到绑定到 claim <code class="highlighter-rouge">default/claim3</code> 的 volume 拥有的回收策略为 <code class="highlighter-rouge">Retain</code>。当用户删除 claim <code class="highlighter-rouge">default/claim3</code> 时，它不会被自动删除。</p>
  </li>
</ol>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>了解更多关于 <a href="/docs/concepts/storage/persistent-volumes/">PersistentVolumes</a>的信息。</li>
  <li>了解更多关于 <a href="/docs/user-guide/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaims</a> 的信息。</li>
</ul>

<h3 id="参考">参考</h3>

<ul>
  <li><a href="/docs/api-reference/v1.8/#persistentvolume-v1-core">PersistentVolume</a></li>
  <li>
    <p><a href="/docs/api-reference/v1.8/#persistentvolumeclaim-v1-core">PersistentVolumeClaim</a></p>
  </li>
  <li>查阅  <a href="/docs/api-reference/v1.8/#persistentvolumeclaim-v1-core">PersistentVolumeSpec</a> 的 <code class="highlighter-rouge">persistentVolumeReclaimPolicy</code> 字段。</li>
</ul>

