
<p>此页面显示了Pod如何使用环境变量把自己的信息呈现给pod中运行的容器。环境变量可以呈现pod的字段和容器字段。</p>

<p>有两种方式可以将Pod和Container字段呈现给运行中的容器：
环境变量 和<a href="/docs/resources-reference/v1.8/#downwardapivolumefile-v1-core">DownwardAPIVolumeFiles</a>.
这两种呈现Pod和Container字段的方式都称为<em>Downward API</em>。</p>

<ul id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#downward-api" id="markdown-toc-downward-api">Downward API</a></li>
  <li><a href="#用pod字段作为环境变量的值" id="markdown-toc-用pod字段作为环境变量的值">用Pod字段作为环境变量的值</a></li>
  <li><a href="#用容器字段作为环境变量的值" id="markdown-toc-用容器字段作为环境变量的值">用容器字段作为环境变量的值</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>

<ul>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<h2 id="downward-api">Downward API</h2>

<p>有两种方式可以将Pod和Container字段呈现给运行中的容器：</p>

<ul>
  <li>环境变量</li>
  <li><a href="/docs/resources-reference/v1.8/#downwardapivolumefile-v1-core">DownwardAPIVolumeFiles</a></li>
</ul>

<p>这两种呈现Pod和Container字段的方式都称为<em>Downward API</em>。</p>

<h2 id="用pod字段作为环境变量的值">用Pod字段作为环境变量的值</h2>

<p>在这个练习中，你将创建一个包含一个容器的pod。这是该pod的配置文件：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/cn/docs/tasks/inject-data-application/dapi-envars-pod.yaml" download="dapi-envars-pod.yaml">
                    <code>dapi-envars-pod.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('dapi-envars-pod.yaml')" title="Copy dapi-envars-pod.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="dapi-envars-pod.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dapi-envars-fieldref</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test-container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/busybox</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">while </span><span class="no">true</span><span class="s">; do</span>
          <span class="s">echo -en '\n';</span>
          <span class="s">printenv MY_NODE_NAME MY_POD_NAME MY_POD_NAMESPACE;</span>
          <span class="s">printenv MY_POD_IP MY_POD_SERVICE_ACCOUNT;</span>
          <span class="s">sleep 10;</span>
        <span class="s">done;</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_NODE_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_POD_NAME</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.name</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_POD_NAMESPACE</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.namespace</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_POD_IP</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">status.podIP</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_POD_SERVICE_ACCOUNT</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">fieldRef</span><span class="pi">:</span>
              <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.serviceAccountName</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>这个配置文件中，你可以看到五个环境变量。<code class="highlighter-rouge">env</code>字段是一个<a href="/docs/resources-reference/v1.8/#envvar-v1-core">EnvVars</a>类型的数组。
数组中第一个元素指定<code class="highlighter-rouge">MY_NODE_NAME</code>这个环境变量从Pod的<code class="highlighter-rouge">spec.nodeName</code>字段获取变量值。同样，其它环境变量也是从Pod的字段获取它们的变量值。</p>

<p class="note"><strong>注意:</strong> 本示例中的字段是Pod字段，不是Pod中容器的字段。</p>

<p>创建Pod：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/cn/docs/tasks/inject-data-application/dapi-envars-pod.yaml
</code></pre></div></div>

<p>验证Pod中的容器运行正常：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p>查看容器日志：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs dapi-envars-fieldref
</code></pre></div></div>

<p>输出信息显示了所选择的环境变量的值：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube
dapi-envars-fieldref
default
172.17.0.4
default
</code></pre></div></div>

<p>要了解为什么这些值在日志中，请查看配置文件中的<code class="highlighter-rouge">command</code> 和 <code class="highlighter-rouge">args</code>字段。 当容器启动时，它将五个环境变量的值写入stdout。每十秒重复执行一次。</p>

<p>接下来，进入Pod中运行的容器，打开一个shell：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it dapi-envars-fieldref -- sh
</code></pre></div></div>

<p>在shell中，查看环境变量：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/# printenv
</code></pre></div></div>

<p>输出信息显示环境变量已经指定为Pod的字段的值。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MY_POD_SERVICE_ACCOUNT=default
...
MY_POD_NAMESPACE=default
MY_POD_IP=172.17.0.4
...
MY_NODE_NAME=minikube
...
MY_POD_NAME=dapi-envars-fieldref
</code></pre></div></div>

<h2 id="用容器字段作为环境变量的值">用容器字段作为环境变量的值</h2>

<p>前面的练习中，你将Pod字段作为环境变量的值。接下来这个练习，你将用容器字段作为环境变量的值。这里是包含一个容器的pod的配置文件：</p>

<table class="includecode">
    <thead>
        <tr>
            <th>
                <a href="https://raw.githubusercontent.com/kubernetes/website/master/cn/docs/tasks/inject-data-application/dapi-envars-container.yaml" download="dapi-envars-container.yaml">
                    <code>dapi-envars-container.yaml</code>
                </a>
                <img src="/images/copycode.svg" style="max-height:24px" onclick="copyCode('dapi-envars-container.yaml')" title="Copy dapi-envars-container.yaml to clipboard" />
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>
<div id="dapi-envars-container.yaml" class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dapi-envars-resourcefieldref</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test-container</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/busybox:1.24</span>
      <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">sh"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">-c"</span><span class="pi">]</span>
      <span class="na">args</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">while </span><span class="no">true</span><span class="s">; do</span>
          <span class="s">echo -en '\n';</span>
          <span class="s">printenv MY_CPU_REQUEST MY_CPU_LIMIT;</span>
          <span class="s">printenv MY_MEM_REQUEST MY_MEM_LIMIT;</span>
          <span class="s">sleep 10;</span>
        <span class="s">done;</span>
      <span class="na">resources</span><span class="pi">:</span>
        <span class="na">requests</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">32Mi"</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">125m"</span>
        <span class="na">limits</span><span class="pi">:</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">64Mi"</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">250m"</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_CPU_REQUEST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">test-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">requests.cpu</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_CPU_LIMIT</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">test-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">limits.cpu</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_MEM_REQUEST</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">test-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">requests.memory</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MY_MEM_LIMIT</span>
          <span class="na">valueFrom</span><span class="pi">:</span>
            <span class="na">resourceFieldRef</span><span class="pi">:</span>
              <span class="na">containerName</span><span class="pi">:</span> <span class="s">test-container</span>
              <span class="na">resource</span><span class="pi">:</span> <span class="s">limits.memory</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
</code></pre></div></div>
</td>
        </tr>
    </tbody>
</table>

<p>这个配置文件中，你可以看到四个环境变量。<code class="highlighter-rouge">env</code>字段是一个<a href="/docs/resources-reference/v1.8/#envvar-v1-core">EnvVars</a>
类型的数组。数组中第一个元素指定<code class="highlighter-rouge">MY_CPU_REQUEST</code>这个环境变量从容器的<code class="highlighter-rouge">requests.cpu</code>字段获取变量值。同样，其它环境变量也是从容器的字段获取它们的变量值。</p>

<p>创建Pod：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/cn/docs/tasks/inject-data-application/dapi-envars-container.yaml
</code></pre></div></div>

<p>验证Pod中的容器运行正常：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods
</code></pre></div></div>

<p>查看容器日志：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl logs dapi-envars-resourcefieldref
</code></pre></div></div>

<p>输出信息显示了所选择的环境变量的值：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1
1
33554432
67108864
</code></pre></div></div>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li><a href="/docs/tasks/configure-pod-container/define-environment-variable-container/">给容器定义环境变量</a></li>
  <li><a href="/docs/resources-reference/v1.8/#podspec-v1-core">PodSpec</a></li>
  <li><a href="/docs/resources-reference/v1.8/#container-v1-core">Container</a></li>
  <li><a href="/docs/resources-reference/v1.8/#envvar-v1-core">EnvVar</a></li>
  <li><a href="/docs/resources-reference/v1.8/#envvarsource-v1-core">EnvVarSource</a></li>
  <li><a href="/docs/resources-reference/v1.8/#objectfieldselector-v1-core">ObjectFieldSelector</a></li>
  <li><a href="/docs/resources-reference/v1.8/#resourcefieldselector-v1-core">ResourceFieldSelector</a></li>
</ul>

