
<p>这篇文档基于<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">在Pods中使用ConfigMap数据</a> 和 <a href="/docs/tasks/configure-pod-container/configmap/">使用ConfigMap来配置Containers</a> 两个任务，提供了一个使用ConfigMap来配置Redis的真实案例。</p>

<ul id="markdown-toc">
  <li><a href="#objectives" id="markdown-toc-objectives">Objectives</a></li>
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you begin</a></li>
  <li><a href="#真实世界的案例使用configmap来配置redis" id="markdown-toc-真实世界的案例使用configmap来配置redis">真实世界的案例：使用ConfigMap来配置Redis</a></li>
  <li><a href="#whats-next" id="markdown-toc-whats-next">What’s next</a></li>
</ul>

<h2 id="objectives">Objectives</h2>

<ul>
  <li>创建一个ConfigMap。</li>
  <li>使用ConfigMap来配置pod参数。</li>
  <li>创建pod。</li>
  <li>验证是否配置成功。</li>
</ul>

<h2 id="before-you-begin">Before you begin</h2>

<ul>
  <li>
    <p>You need to have a Kubernetes cluster, and the kubectl command-line tool must
be configured to communicate with your cluster. If you do not already have a
cluster, you can create one by using
<a href="/docs/getting-started-guides/minikube">Minikube</a>,
or you can use one of these Kubernetes playgrounds:</p>
  </li>
  <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li>
  <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li>
</ul>

<p>To check the version, enter <code class="highlighter-rouge">kubectl version</code>.</p>

<ul>
  <li>理解<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">在Pods中使用ConfigMap数据</a>。</li>
  <li>理解<a href="/docs/tasks/configure-pod-container/configmap/">使用ConfigMap来配置Containers</a>。</li>
</ul>

<h2 id="真实世界的案例使用configmap来配置redis">真实世界的案例：使用ConfigMap来配置Redis</h2>

<p>按照下面的步骤，您可以使用ConfigMap中的数据来配置Redis缓存。</p>

<ol>
  <li>
    <p>根据<code class="highlighter-rouge">docs/user-guide/configmap/redis/redis-config</code>来创建一个ConfigMap：</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create configmap example-redis-config <span class="nt">--from-file</span><span class="o">=</span>docs/user-guide/configmap/redis/redis-config

kubectl get configmap example-redis-config <span class="nt">-o</span> yaml
</code></pre></div>    </div>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">redis-config</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="no">maxmemory 2mb</span>
    <span class="no">maxmemory-policy allkeys-lru</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">creationTimestamp</span><span class="pi">:</span> <span class="s">2016-03-30T18:14:41Z</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-redis-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">24686"</span>
  <span class="na">selfLink</span><span class="pi">:</span> <span class="s">/api/v1/namespaces/default/configmaps/example-redis-config</span>
  <span class="na">uid</span><span class="pi">:</span> <span class="s">460a2b6e-f6a3-11e5-8ae5-42010af00002</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用ConfigMap来配置pod参数：</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">redis</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">redis</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">kubernetes/redis:v1</span>
    <span class="na">env</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MASTER</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">6379</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="na">limits</span><span class="pi">:</span>
        <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0.1"</span>
    <span class="na">volumeMounts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/redis-master-data</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
    <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/redis-master</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config</span>
      <span class="na">configMap</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">example-redis-config</span>
        <span class="na">items</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">redis-config</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">redis.conf</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建pod:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> docs/user-guide/configmap/redis/redis-pod.yaml
</code></pre></div>    </div>

    <p>In the example, the config volume is mounted at <code class="highlighter-rouge">/redis-master</code>.
It uses <code class="highlighter-rouge">path</code> to add the <code class="highlighter-rouge">redis-config</code> key to a file named <code class="highlighter-rouge">redis.conf</code>.
The file path for the redis config, therefore, is <code class="highlighter-rouge">/redis-master/redis.conf</code>.
This is where the image will look for the config file for the redis master.</p>
  </li>
  <li>
    <p>使用<code class="highlighter-rouge">kubectl exec</code>命令进入pod后运行 <code class="highlighter-rouge">redis-cli</code> 工具来验证配置是否成功：</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> redis redis-cli
127.0.0.1:6379&gt; CONFIG GET maxmemory
1<span class="o">)</span> <span class="s2">"maxmemory"</span>
2<span class="o">)</span> <span class="s2">"2097152"</span>
127.0.0.1:6379&gt; CONFIG GET maxmemory-policy
1<span class="o">)</span> <span class="s2">"maxmemory-policy"</span>
2<span class="o">)</span> <span class="s2">"allkeys-lru"</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="whats-next">What’s next</h2>

<ul>
  <li>了解关于<a href="/docs/tasks/configure-pod-container/configmap/">ConfigMaps</a>的更多知识。</li>
  <li>参见<a href="/docs/tasks/configure-pod-container/configure-pod-configmap/">在Pods中使用ConfigMap数据</a>。</li>
</ul>

